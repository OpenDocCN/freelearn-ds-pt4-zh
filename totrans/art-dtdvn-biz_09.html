<html><head></head><body>
<div id="_idContainer237">
<h1 class="chapter-number" id="_idParaDest-89"><a id="_idTextAnchor1188"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-90"><a id="_idTextAnchor1189"/><span class="koboSpan" id="kobo.2.1">Using Historical Markdown Data to Predict Sales</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Many retailers have no choice but to follow the industry trend of increased use of discounts and special marketing to maintain a competitive edge in today’s oversaturated market. </span><span class="koboSpan" id="kobo.3.2">This is because most of the new customers are more price-sensitive and will check prices across websites to discover the bests offers for </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">specific products.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">Discounting, however, has its drawbacks. </span><span class="koboSpan" id="kobo.5.2">While promotions can speed up sales, businesses also run the danger of further profit loss when offering discounts without conducting adequate research. </span><span class="koboSpan" id="kobo.5.3">One challenge of modeling retail data is the need to make decisions based on limited history. </span><span class="koboSpan" id="kobo.5.4">If Christmas comes but once a year, so does the chance to see how strategic decisions impacted the </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">bottom line.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">In this chapter, we delve deeper into the most recent markdown and discount marketing tactics used by industry leaders and show you how to implement them while maintaining profit margins. </span><span class="koboSpan" id="kobo.7.2">We will use historical sales information from 45 supermarkets spread across several areas. </span><span class="koboSpan" id="kobo.7.3">Although it is well recognized that these markdowns have an influence on sales, it can be difficult to foresee which departments will be impacted and how much, so our goal will be to forecast the sales for each department in each store, which has multiple departments. </span><span class="koboSpan" id="kobo.7.4">Selected holiday markdown events are included in the dataset to increase </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">the difficulty.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we will learn how to do </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.11.1">Determine sales performance considering all the factors that </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">impact it</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Explore the sales data to determine factors that </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">affect sales</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Study the effect of promotional markdown on sales </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">during holidays</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Predict the sales given specific </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">markdowns applied</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.19.1">We will be using data that reflects actual real data to try to get as close as possible to </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">real-life situations.</span></span></p>
<h1 id="_idParaDest-91"><a id="_idTextAnchor1190"/><span class="koboSpan" id="kobo.21.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.22.1">To be able to follow the steps in this chapter, you will need to meet the </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">next requirements:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.24.1">A Jupyter notebook instance running Python 3.7 and above. </span><span class="koboSpan" id="kobo.24.2">You can use the Google Colab notebook to run the steps as well if you have a Google </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">Drive account.</span></span></li>
<li><span class="koboSpan" id="kobo.26.1">An understanding of basic math and </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">statistical concepts.</span></span></li>
</ul>
<h1 id="_idParaDest-92"><a id="_idTextAnchor1191"/><span class="koboSpan" id="kobo.28.1">Creating effective markdowns</span></h1>
<p><span class="koboSpan" id="kobo.29.1">A markdown</span><a id="_idIndexMarker421"/><span class="koboSpan" id="kobo.30.1"> is a devaluation of a product because it cannot be sold at the original selling price. </span><span class="koboSpan" id="kobo.30.2">An example of a discount would be if you have an item that after a month of slow sales you decide to discount by 20%. </span><span class="koboSpan" id="kobo.30.3">Even if you just lost revenue, it </span><a id="_idIndexMarker422"/><span class="koboSpan" id="kobo.31.1">also invites more people to buy it at a lower price. </span><span class="koboSpan" id="kobo.31.2">Since the item didn’t originally sell well, offering a good discounted price can often lead to sales that otherwise wouldn’t have happened. </span><span class="koboSpan" id="kobo.31.3">However, you will often find that you need to pursue your markdown strategies based on slow sales, moving products from 20% to 30%, 40%, and more as needed. </span><span class="koboSpan" id="kobo.31.4">Timing is particularly important because you want to sell the product while it is still relevant to the season, trends, </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">and more.</span></span></p>
<p><span class="koboSpan" id="kobo.33.1">Markdowns need to be differentiated from discounts. </span><span class="koboSpan" id="kobo.33.2">In retail, a discount is a reduction in the price of an item or transaction based on the type of customer who is buying. </span><span class="koboSpan" id="kobo.33.3">The employee discount, senior discount, and frequent shopper discount are a few examples. </span><span class="koboSpan" id="kobo.33.4">Because of the discounts they receive, many retailers believe that this makes the customers more likely to return to their store than to one of </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">their competitors.</span></span></p>
<p><span class="koboSpan" id="kobo.35.1">In this chapter, we will use historical sales information from stores located in various locations in the US. </span><span class="koboSpan" id="kobo.35.2">Each store has a range of departments, and we will forecast the department-wide sales. </span><span class="koboSpan" id="kobo.35.3">Additionally, the company hosts a number of promotional markdown sales all year round, out of which the Super Bowl, Labor Day, Thanksgiving, and Christmas are the four </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">biggest holidays.</span></span></p>
<p><span class="koboSpan" id="kobo.37.1">In addition, Walmart runs several promotional markdown events throughout the year. </span><span class="koboSpan" id="kobo.37.2">These markdowns precede prominent holidays, the four largest of which are the Super Bowl, Labor Day, Thanksgiving, and Christmas. </span><span class="koboSpan" id="kobo.37.3">The weeks including these holidays are weighted five times higher in the evaluation than non-holiday weeks. </span><span class="koboSpan" id="kobo.37.4">Part of the </span><a id="_idIndexMarker423"/><span class="koboSpan" id="kobo.38.1">challenge presented by this competition is modeling the effects of markdowns on these holiday weeks in the absence of complete/ideal </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">historical data.</span></span></p>
<p><span class="koboSpan" id="kobo.40.1">In the next section, we will analyze the data to understand the variables, its distribution, and we will structure it for better visualization and for use in </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">machine learnin</span><a id="_idTextAnchor1192"/><span class="koboSpan" id="kobo.42.1">g.</span></span></p>
<h1 id="_idParaDest-93"><a id="_idTextAnchor1193"/><span class="koboSpan" id="kobo.43.1">Analyzing the data</span></h1>
<p><span class="koboSpan" id="kobo.44.1">We are </span><a id="_idIndexMarker424"/><span class="koboSpan" id="kobo.45.1">provided with 3 files, which contain anonymized information about the 45 stores, indicating the type and size of the store, historical training data, which covers 2010-02-05 to 2012-11-01, and a file that contains additional data related to the store, department, and regional activity for the </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">given dates.</span></span></p>
<p><span class="koboSpan" id="kobo.47.1">In the next example, the following Python modules </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">were used:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.49.1">pandas: A Python package for data analysis and </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">data manipulation</span></span></li>
<li><span class="koboSpan" id="kobo.51.1">NumPy: This is a library that adds support for large, multi-dimensional arrays and matrices, along with an ample collection of high-level mathematical functions to operate on </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">these arrays</span></span></li>
<li><span class="koboSpan" id="kobo.53.1">Seaborn and Matplotlib: Python packages for effective </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">data visualization</span></span></li>
</ul>
<ol>
<li><span class="koboSpan" id="kobo.55.1">We will start the analysis by importing the libraries, and we will start to analyze the data by reading all the files and parsing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.56.1">Date</span></strong><span class="koboSpan" id="kobo.57.1"> column using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.58.1">parse_date</span></strong><span class="koboSpan" id="kobo.59.1"> option of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.60.1">read_csv</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.61.1">pandas functi</span><a id="_idTextAnchor1194"/><span class="koboSpan" id="kobo.62.1">on:</span></span><pre class="console"><span class="koboSpan" id="kobo.63.1">
import pandas as pd # data process</span><a id="_idTextAnchor1195"/><span class="koboSpan" id="kobo.64.1">ing</span></pre><pre class="console"><span class="koboSpan" id="kobo.65.1">
import matplotlib.pyplot as plt # visualizat</span><a id="_idTextAnchor1196"/><span class="koboSpan" id="kobo.66.1">ion</span></pre><pre class="console"><span class="koboSpan" id="kobo.67.1">
import seaborn as sns # visualizat</span><a id="_idTextAnchor1197"/><span class="koboSpan" id="kobo.68.1">ion</span></pre><pre class="console"><span class="koboSpan" id="kobo.69.1">
train=pd.read_csv("/content/train.csv", </span></pre><pre class="console"><span class="koboSpan" id="kobo.70.1">
      parse_dates=["Date</span><a id="_idTextAnchor1198"/><span class="koboSpan" id="kobo.71.1">"])</span></pre><pre class="console"><span class="koboSpan" id="kobo.72.1">
features=pd.read_csv("/content/features.csv", </span></pre><pre class="console"><span class="koboSpan" id="kobo.73.1">
      parse_dates=["Date</span><a id="_idTextAnchor1199"/><span class="koboSpan" id="kobo.74.1">"])</span></pre><pre class="console"><span class="koboSpan" id="kobo.75.1">
stores=pd.read_csv("/content/stores.csv")</span></pre></li>
<li><span class="koboSpan" id="kobo.76.1">Now that</span><a id="_idIndexMarker425"/><span class="koboSpan" id="kobo.77.1"> all the files are loaded, we can start by looking at the first rows of the </span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">train f</span><a id="_idTextAnchor1200"/><span class="koboSpan" id="kobo.79.1">ile:</span></span><pre class="console"><span class="koboSpan" id="kobo.80.1">
train.head(</span><a id="_idTextAnchor1201"/><span class="koboSpan" id="kobo.81.1">)</span></pre></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer213">
<span class="koboSpan" id="kobo.82.1"><img alt="Figure 9.1: Train file with weekly sales for the store, day, and department " src="image/B19026_09_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.83.1">Figure 9.1: Train file with weekly sales for the store, day, and department</span></p>
<p><span class="koboSpan" id="kobo.84.1">The file contains weekly sales data for each store and department, flagging also whether this day is a holiday </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">or not.</span></span></p>
<p><span class="koboSpan" id="kobo.86.1">We will also introduce some date variables to make the </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">analysis easier:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.88.1">
train['Year']=train['Date'].dt.year
train['Month']=train['Date'].dt.month
train['Week']=train['Date'].dt.week
train['Day']=train['Date'].dt.day</span></pre>
<ol>
<li value="3"><span class="koboSpan" id="kobo.89.1">The next file we will look at contains information about each story in terms of type and size. </span><span class="koboSpan" id="kobo.89.2">We can use this information later to assess if the effects of markdown vary depending on the </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">store characteristi</span><a id="_idTextAnchor1202"/><span class="koboSpan" id="kobo.91.1">cs:</span></span><pre class="console"><span class="koboSpan" id="kobo.92.1">
stores.head()</span><a id="_idTextAnchor1203"/></pre></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer214">
<span class="koboSpan" id="kobo.93.1"><img alt="Figure 9.2: Store type and size data " src="image/B19026_09_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.94.1">Figure 9.2: Store type and size data</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.95.1">We can start</span><a id="_idIndexMarker426"/><span class="koboSpan" id="kobo.96.1"> to visualize the data by looking at the distribution of sales types and sizes using the boxplot from Seaborn. </span><span class="koboSpan" id="kobo.96.2">In the next block of code, we create a subset of data concatenating the </span><strong class="bold"><span class="koboSpan" id="kobo.97.1">Type</span></strong><span class="koboSpan" id="kobo.98.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.99.1">Size</span></strong><span class="koboSpan" id="kobo.100.1"> columns of the store’s data. </span><span class="koboSpan" id="kobo.100.2">Then, we create a figure, using Matplotlib, of 8x6 inches, which will contain the </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">seaborn figu</span><a id="_idTextAnchor1204"/><span class="koboSpan" id="kobo.102.1">re:</span></span><pre class="console"><span class="koboSpan" id="kobo.103.1">
data = pd.concat([stores['Type'], stores['Size']], axis</span><a id="_idTextAnchor1205"/><span class="koboSpan" id="kobo.104.1">=1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.105.1">
f, ax = plt.subplots(figsize=(8, </span><a id="_idTextAnchor1206"/><span class="koboSpan" id="kobo.106.1">6))</span></pre><pre class="console"><span class="koboSpan" id="kobo.107.1">
fig = sns.boxplot(x='Type', y='Size', data=data)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.108.1">The code will show us the distribution of the </span><span class="No-Break"><span class="koboSpan" id="kobo.109.1">store size.</span></span><a id="_idTextAnchor1207"/></p>
<div>
<div class="IMG---Figure" id="_idContainer215">
<span class="koboSpan" id="kobo.110.1"><img alt="Figure 9.3: Store type and size data " src="image/B19026_09_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.111.1">Figure 9.3: Store type and size data</span></p>
<p><span class="koboSpan" id="kobo.112.1">Within size, we can see that there are three types of stores, out of which type A is the biggest. </span><span class="koboSpan" id="kobo.112.2">It is interesting to see the variation between the quantiles as well as </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">the outliers.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.114.1">Finally, the </span><a id="_idIndexMarker427"/><span class="koboSpan" id="kobo.115.1">next file contains more contextual data about each day and store. </span><span class="koboSpan" id="kobo.115.2">This information is about temperature, fuel price, and the different markdowns applied divided into five types, consumer price index, unemployment, and information about whether the day was a holiday </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">or n</span><a id="_idTextAnchor1208"/><span class="koboSpan" id="kobo.117.1">ot:</span></span><pre class="console"><span class="koboSpan" id="kobo.118.1">
features.head()</span><a id="_idTextAnchor1209"/></pre></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer216">
<span class="koboSpan" id="kobo.119.1"><img alt="Figure 9.4: Contextual data by store " src="image/B19026_09_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.120.1">Figure 9.4: Contextual data by store</span></p>
<p><span class="koboSpan" id="kobo.121.1">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">merge</span></strong><span class="koboSpan" id="kobo.123.1"> method in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.124.1">train</span></strong><span class="koboSpan" id="kobo.125.1"> pandas DataFrame to attach information about the day, the size of the store, and the type contained in the </span><span class="No-Break"><span class="koboSpan" id="kobo.126.1">store’s DataFrame:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.127.1">
train=train.merge(stores, on='Store', how='left</span><a id="_idTextAnchor1210"/><span class="koboSpan" id="kobo.128.1">')
train.head()</span></pre>
<p><span class="koboSpan" id="kobo.129.1">The </span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.130.1">previous code will merge the data and show the first </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">few lines.</span></span><a id="_idTextAnchor1211"/></p>
<div>
<div class="IMG---Figure" id="_idContainer217">
<span class="koboSpan" id="kobo.132.1"><img alt="Figure 9.5: Weekly sales data with information about holidays, store type, and size " src="image/B19026_09_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.133.1">Figure 9.5: Weekly sales data with information about holidays, store type, and size</span></p>
<p><span class="koboSpan" id="kobo.134.1">We can now visualize the distribution of weekly sales by type of store. </span><span class="koboSpan" id="kobo.134.2">We will create a subset of data using the </span><strong class="bold"><span class="koboSpan" id="kobo.135.1">Type</span></strong><span class="koboSpan" id="kobo.136.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.137.1">Weekly_Sales</span></strong><span class="koboSpan" id="kobo.138.1"> column, creating a Matplotlib figure of 8x6 inches, which then is filled with a </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">seaborn boxplo</span><a id="_idTextAnchor1212"/><span class="koboSpan" id="kobo.140.1">t:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.141.1">
data = pd.concat([train['Type'], train['Weekly_Sales']], axis=</span><a id="_idTextAnchor1213"/><span class="koboSpan" id="kobo.142.1">1)
f, ax = plt.subplots(figsize=(8, 6</span><a id="_idTextAnchor1214"/><span class="koboSpan" id="kobo.143.1">))
fig = sns.boxplot(x='Type', y='Weekly_Sales', data=data, showfliers=False)</span></pre>
<p><span class="koboSpan" id="kobo.144.1">This will generate boxplot visualizations by type </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">of store.</span></span></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor1215"/></p>
<div>
<div class="IMG---Figure" id="_idContainer218">
<span class="koboSpan" id="kobo.146.1"><img alt="Figure 9.6: Boxplot of weekly sales by type " src="image/B19026_09_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.147.1">Figure 9.6: Boxplot of weekly sales by type</span></p>
<p><span class="koboSpan" id="kobo.148.1">In relation to</span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.149.1"> the type of store, we can see that although the A is the smallest one, it is the one with the highest </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">median sales.</span></span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.151.1">We will now create a boxplot of the distribution of sales data by store ID. </span><span class="koboSpan" id="kobo.151.2">We create a subset of data with the columns </span><strong class="bold"><span class="koboSpan" id="kobo.152.1">Store</span></strong><span class="koboSpan" id="kobo.153.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.154.1">Weekly_Sales</span></strong><span class="koboSpan" id="kobo.155.1"> from the train data, create a Matplotlib figure of 25x8 inches, and show a seaborn boxplot where the x-axis is the store ID and a color differentiation </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">by typ</span><a id="_idTextAnchor1216"/><span class="koboSpan" id="kobo.157.1">e:</span></span><pre class="console"><span class="koboSpan" id="kobo.158.1">
data = pd.concat([train['Store'], train['Weekly_Sales'], train['Type']], axis=</span><a id="_idTextAnchor1217"/><span class="koboSpan" id="kobo.159.1">1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.160.1">
f, ax = plt.subplots(figsize=(25, 8</span><a id="_idTextAnchor1218"/><span class="koboSpan" id="kobo.161.1">))</span></pre><pre class="console"><span class="koboSpan" id="kobo.162.1">
fig = sns.boxplot(x='Store', y='Weekly_Sales', data=data, showfliers=False, hue="Type")</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.163.1">The code will generate boxplots of the weekly sales </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">by store.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1219"/></p>
<div>
<div class="IMG---Figure" id="_idContainer219">
<span class="koboSpan" id="kobo.165.1"><img alt="Figure 9.7: Weekly sales data by store ID and type " src="image/B19026_09_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.166.1">Figure 9.7: Weekly sales data by store ID and type</span></p>
<p><span class="koboSpan" id="kobo.167.1">From the</span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.168.1"> boxplot, we can see that store can be the variable giving information on sales, as there is a consistent pattern of high upper boundaries sales in all types. </span><span class="koboSpan" id="kobo.168.2">This is an indication that there are moments in which the demand increases in a short amount of time. </span><span class="koboSpan" id="kobo.168.3">Also, there are no indications of having moments in which the demand falls drastically under </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">the median.</span></span></p>
<p><span class="koboSpan" id="kobo.170.1">Much intrinsic information on type, size, and department is included in the store data. </span><span class="koboSpan" id="kobo.170.2">Therefore, we will look at how the holidays </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">impact sales.</span></span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.172.1">We repeat the same pattern of creating a subset of data, a Matplotlib figure, and a seaborn boxplot, but now the hue variable is set to the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.173.1">IsHoliday</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.174.1"> colum</span><a id="_idTextAnchor1220"/><span class="koboSpan" id="kobo.175.1">n:</span></span><pre class="console"><span class="koboSpan" id="kobo.176.1">
data = pd.concat([train['Store'], train['Weekly_Sales'], train['IsHoliday']], axis=</span><a id="_idTextAnchor1221"/><span class="koboSpan" id="kobo.177.1">1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.178.1">
f, ax = plt.subplots(figsize=(25, 8</span><a id="_idTextAnchor1222"/><span class="koboSpan" id="kobo.179.1">))</span></pre><pre class="console"><span class="koboSpan" id="kobo.180.1">
fig = sns.boxplot(x='Store', y='Weekly_Sales', data=data, showfliers=False, hue="IsHoliday")</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.181.1">This code will show us the distribution of sales with even more levels </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">of information.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1223"/></p>
<div>
<div class="IMG---Figure" id="_idContainer220">
<span class="koboSpan" id="kobo.183.1"><img alt="Figure 9.8: Weekly sales data by store ID during and excluding holidays " src="image/B19026_09_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.184.1">Figure 9.8: Weekly sales data by store ID during and excluding holidays</span></p>
<p><span class="koboSpan" id="kobo.185.1">We can</span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.186.1"> see from the data that </span><strong class="bold"><span class="koboSpan" id="kobo.187.1">Holiday</span></strong><span class="koboSpan" id="kobo.188.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.189.1">Store</span></strong><span class="koboSpan" id="kobo.190.1"> do not show significant relations except for a small higher sales soaring during the holiday day. </span><span class="koboSpan" id="kobo.190.2">This may imply that most of the sales are done days before the </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">holiday itself.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.192.1">Now, let us dive into the difference in sales by type of department. </span><span class="koboSpan" id="kobo.192.2">To do this, we will create a subset of data as the grouping of the weekly sales per department, then apply the mean, and reset the index. </span><span class="koboSpan" id="kobo.192.3">We show the data using a bar plot because otherwise, it would be impossible to see at glance any difference in a boxplot because of the number </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">of department</span><a id="_idTextAnchor1224"/><span class="koboSpan" id="kobo.194.1">s:</span></span><pre class="console"><span class="koboSpan" id="kobo.195.1">
data= train[['Dept','Weekly_Sales']].groupby('Dept').mean().reset_index</span><a id="_idTextAnchor1225"/><span class="koboSpan" id="kobo.196.1">()</span></pre><pre class="console"><span class="koboSpan" id="kobo.197.1">
f, ax = plt.subplots(figsize=(25, 8</span><a id="_idTextAnchor1226"/><span class="koboSpan" id="kobo.198.1">))</span></pre><pre class="console"><span class="koboSpan" id="kobo.199.1">
fig = sns.barplot(x='Dept', y='Weekly_Sales', data=data)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.200.1">This visualization will give us a perspective of sales </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">by department.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1227"/></p>
<div>
<div class="IMG---Figure" id="_idContainer221">
<span class="koboSpan" id="kobo.202.1"><img alt="Figure 9.9: Weekly median sale by department " src="image/B19026_09_9.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.203.1">Figure 9.9: Weekly median sale by department</span></p>
<p><span class="koboSpan" id="kobo.204.1">We can </span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.205.1">see that there is variation between the sales of different departments. </span><span class="koboSpan" id="kobo.205.2">We have a high concentration of revenue in some of them, which could lead us to consider excluding the ones with smaller sales. </span><span class="koboSpan" id="kobo.205.3">This may not be appropriate as these departments may allow customers that just look for those items to go to that store and then buy other items. </span><span class="koboSpan" id="kobo.205.4">You could study this further using analysis such as the </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">Apriori algorithm.</span></span></p>
<ol>
<li value="9"><span class="koboSpan" id="kobo.207.1">Next, we will visualize the weekly sales by month to glimpse at the seasonality of the data. </span><span class="koboSpan" id="kobo.207.2">We create a subset of data with the columns and visualize the data with </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">a boxplo</span><a id="_idTextAnchor1228"/><span class="koboSpan" id="kobo.209.1">t:</span></span><pre class="console"><span class="koboSpan" id="kobo.210.1">
data = pd.concat([train['Month'], train['Weekly_Sales']], axis=</span><a id="_idTextAnchor1229"/><span class="koboSpan" id="kobo.211.1">1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.212.1">
f, ax = plt.subplots(figsize=(8, 6</span><a id="_idTextAnchor1230"/><span class="koboSpan" id="kobo.213.1">))</span></pre><pre class="console"><span class="koboSpan" id="kobo.214.1">
fig = sns.boxplot(x='Month', y="Weekly_Sales", data=data, showfliers=False)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.215.1">The following is the distribution of </span><span class="No-Break"><span class="koboSpan" id="kobo.216.1">monthly sales.</span></span></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor1231"/></p>
<div>
<div class="IMG---Figure" id="_idContainer222">
<span class="koboSpan" id="kobo.217.1"><img alt="Figure 9.10: Weekly sales by month " src="image/B19026_09_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.218.1">Figure 9.10: Weekly sales by month</span></p>
<p><span class="koboSpan" id="kobo.219.1">We can </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.220.1">explore the monthly sales further by visualizing the behavior of the holidays in the sales by month. </span><span class="koboSpan" id="kobo.220.2">We do this by setting the hue value of the boxplot </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">IsHolida</span><a id="_idTextAnchor1232"/><span class="koboSpan" id="kobo.223.1">y</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.225.1">
data = pd.concat([train['Month'], train[
      'Weekly_Sales'],train['IsHoliday']], axis=</span><a id="_idTextAnchor1233"/><span class="koboSpan" id="kobo.226.1">1)
f, ax = plt.subplots(figsize=(8, 6</span><a id="_idTextAnchor1234"/><span class="koboSpan" id="kobo.227.1">))
fig = sns.boxplot(x='Month', y="Weekly_Sales", data=data, showfliers=False, hue='IsHoliday')</span></pre>
<p><span class="koboSpan" id="kobo.228.1">The following plot is the distribution of sales by month </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">and holidays.</span></span></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor1235"/></p>
<div>
<div class="IMG---Figure" id="_idContainer223">
<span class="koboSpan" id="kobo.230.1"><img alt="Figure 9.11: Weekly sales by month differentiating holidays " src="image/B19026_09_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.231.1">Figure 9.11: Weekly sales by month differentiating holidays</span></p>
<p><span class="koboSpan" id="kobo.232.1">For most of the holidays, the sales on the day of the holiday are slightly higher</span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.233.1"> than on regular days, apart from Christmas, which is </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">in Decembe</span><a id="_idTextAnchor1236"/><a id="_idTextAnchor1237"/><a id="_idTextAnchor1238"/><a id="_idTextAnchor1239"/><a id="_idTextAnchor1240"/><span class="koboSpan" id="kobo.235.1">r.</span></span></p>
<p><span class="koboSpan" id="kobo.236.1">Now, we can create a seaborn relplot to visualize the data </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">per week</span><a id="_idTextAnchor1241"/><span class="koboSpan" id="kobo.238.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.239.1">
data = pd.concat([train['Week'], train['Weekly_Sales'],train['Type']], axis=</span><a id="_idTextAnchor1242"/><span class="koboSpan" id="kobo.240.1">1)
sns.relplot(x='Week', y="Weekly_Sales", data=data, hue='Type',kind='line',height=8, aspect=2.2)</span></pre>
<p><span class="koboSpan" id="kobo.241.1">This plot shows us the median and the </span><span class="No-Break"><span class="koboSpan" id="kobo.242.1">confidence intervals.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1243"/></p>
<div>
<div class="IMG---Figure" id="_idContainer224">
<span class="koboSpan" id="kobo.243.1"><img alt="Figure 9.12: Weekly sales through time " src="image/B19026_09_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.244.1">Figure 9.12: Weekly sales through time</span></p>
<p><span class="koboSpan" id="kobo.245.1">By looking at the relplot, we can see the sharp increase in sales between weeks 40 </span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">and 50.</span></span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.247.1">We can </span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.248.1">visualize the weekly sales data by using a boxplot with </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">Week</span></strong><span class="koboSpan" id="kobo.250.1"> on the x-axis and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">Weekly_Sales</span></strong><span class="koboSpan" id="kobo.252.1"> colum</span><a id="_idTextAnchor1244"/><span class="koboSpan" id="kobo.253.1">n on the </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">y-axis :</span></span><pre class="console"><span class="koboSpan" id="kobo.255.1">
data = pd.concat([train['Week'], train['Weekly_Sales']], axis=</span><a id="_idTextAnchor1245"/><span class="koboSpan" id="kobo.256.1">1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.257.1">
f, ax = plt.subplots(figsize=(20, 6</span><a id="_idTextAnchor1246"/><span class="koboSpan" id="kobo.258.1">))</span></pre><pre class="console"><span class="koboSpan" id="kobo.259.1">
fig = sns.boxplot(x='Week', y="Weekly_Sales", data=data, showfliers=False)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.260.1">This plot shows us the median and the confidence intervals by week of </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">the year.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1247"/></p>
<div>
<div class="IMG---Figure" id="_idContainer225">
<span class="koboSpan" id="kobo.262.1"><img alt="Figure 9.13: Weekly sales by the week of the year " src="image/B19026_09_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.263.1">Figure 9.13: Weekly sales by the week of the year</span></p>
<p><span class="koboSpan" id="kobo.264.1">We can</span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.265.1"> see now that the holiday in the first month of the year produces a minor increase, while the ones in the last part of the year have the biggest increase in sales, including a sudden drop in the </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">week after.</span></span></p>
<ol>
<li value="11"><span class="koboSpan" id="kobo.267.1">We can plot the data now using a seaborn relplot using the dates and the weekly sales as well as making a differentiation by type of store with the </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">hue paramete</span><a id="_idTextAnchor1248"/><span class="koboSpan" id="kobo.269.1">r:</span></span><pre class="console"><span class="koboSpan" id="kobo.270.1">
data = pd.concat([train['Date'], train[</span></pre><pre class="console"><span class="koboSpan" id="kobo.271.1">
      'Weekly_Sales'],train['Type']], axis=</span><a id="_idTextAnchor1249"/><span class="koboSpan" id="kobo.272.1">1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.273.1">
sns.relplot(x='Date', y="Weekly_Sales", data=data, hue='Type',kind='line',height=8, aspect=2.2)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.274.1">The preceding code plots the data with a </span><span class="No-Break"><span class="koboSpan" id="kobo.275.1">confidence band.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1250"/></p>
<div>
<div class="IMG---Figure" id="_idContainer226">
<span class="koboSpan" id="kobo.276.1"><img alt="Figure 9.14: Weekly sales through time " src="image/B19026_09_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.277.1">Figure 9.14: Weekly sales through time</span></p>
<p><span class="koboSpan" id="kobo.278.1">We can observe that the same patterns repeat in the two years of data contained, which could be further explained if we would look at the seasonality</span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.279.1"> of the data, which are the recurring patterns that happen every certain period of time. </span><span class="koboSpan" id="kobo.279.2">The cycles of buying patterns repeat during the last part of the year, showing a sharp increase during the weeks </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">before Christmas.</span></span></p>
<ol>
<li value="12"><span class="koboSpan" id="kobo.281.1">Our next step will be to analyze the mean values of weekly sales, making a differentiation by week and markdown applied. </span><span class="koboSpan" id="kobo.281.2">To do this, first, we will group the weekly sales by week and apply the mean, and we print the shape as a </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">sanity tes</span><a id="_idTextAnchor1251"/><span class="koboSpan" id="kobo.283.1">t:</span></span><pre class="console"><span class="koboSpan" id="kobo.284.1">
data_store = train[['Week','Weekly_Sales']].groupby(['Week']).mean().reset_index</span><a id="_idTextAnchor1252"/><span class="koboSpan" id="kobo.285.1">()</span></pre><pre class="console"><span class="koboSpan" id="kobo.286.1">
data_store.sha</span><a id="_idTextAnchor1253"/><span class="koboSpan" id="kobo.287.1">pe</span></pre><pre class="console"><span class="koboSpan" id="kobo.288.1">
&gt;&gt;&gt;(52, 2)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.289.1">Then, we can get the information from the features DataFrame about markdowns applied in that specific week and apply the mean </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">as wel</span><a id="_idTextAnchor1254"/><span class="koboSpan" id="kobo.291.1">l:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.292.1">
data_features = features[['Week','MarkDown1','MarkDown2',
'MarkDown3','MarkDown4','MarkDown5']].groupby(['Week']).mean().reset_index</span><a id="_idTextAnchor1255"/><span class="koboSpan" id="kobo.293.1">()
data_features.sha</span><a id="_idTextAnchor1256"/><span class="koboSpan" id="kobo.294.1">pe
&gt;&gt;&gt;(52, 6)</span></pre>
<ol>
<li value="13"><span class="koboSpan" id="kobo.295.1">We can </span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.296.1">now merge both DataFrames and obtain information about the median sale per week as well as the type of </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">markdown appli</span><a id="_idTextAnchor1257"/><span class="koboSpan" id="kobo.298.1">ed:</span></span><pre class="console"><span class="koboSpan" id="kobo.299.1">
data_store = data_store.merge(data_features,on=['Week'],how='left').fillna(</span><a id="_idTextAnchor1258"/><span class="koboSpan" id="kobo.300.1">.0)</span></pre><pre class="console"><span class="koboSpan" id="kobo.301.1">
data_store.index = data_store['Wee</span><a id="_idTextAnchor1259"/><span class="koboSpan" id="kobo.302.1">k']</span></pre><pre class="console"><span class="koboSpan" id="kobo.303.1">
data_store = data_store.drop(['Week'],axis</span><a id="_idTextAnchor1260"/><span class="koboSpan" id="kobo.304.1">=1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.305.1">
data_store.head()</span><a id="_idTextAnchor1261"/></pre></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer227">
<span class="koboSpan" id="kobo.306.1"><img alt="Figure 9.15: Median weekly sales and markdowns per week " src="image/B19026_09_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.307.1">Figure 9.15: Median weekly sales and markdowns per week</span></p>
<p><span class="koboSpan" id="kobo.308.1">Using this information, we can now plot the data to see the impact of discounts in comparison with the </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">weekly sale</span><a id="_idTextAnchor1262"/><span class="koboSpan" id="kobo.310.1">s:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.311.1">
data_store.plot(figsize=(20,8))</span></pre>
<p class="IMG---Figure"><a id="_idTextAnchor1263"/></p>
<div>
<div class="IMG---Figure" id="_idContainer228">
<span class="koboSpan" id="kobo.312.1"><img alt="Figure 9.16: Median weekly sales and markdowns per week " src="image/B19026_09_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.313.1">Figure 9.16: Median weekly sales and markdowns per week</span></p>
<p><span class="koboSpan" id="kobo.314.1">We can </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.315.1">see from the data that many markdowns are applied immediately before Christmas and then in the weeks that follow it. </span><span class="koboSpan" id="kobo.315.2">The answer may be that these markdowns are applied to reduce the stock of products that were not bought during the </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">holiday period.</span></span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.317.1">Now, we will look at the relationship between sales and the features describing the conditions for each day and store. </span><span class="koboSpan" id="kobo.317.2">To do this, we group the sales data by week and apply the mean. </span><span class="koboSpan" id="kobo.317.3">We then do the same for the features data and finally merge </span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">both DataFrame</span><a id="_idTextAnchor1264"/><span class="koboSpan" id="kobo.319.1">s:</span></span><pre class="console"><span class="koboSpan" id="kobo.320.1">
data_features = features.drop(['Store','Date','MarkDown1',</span></pre><pre class="console"><span class="koboSpan" id="kobo.321.1">
'MarkDown2','MarkDown3','MarkDown4','MarkDown5'],axis=1).groupby(['Week']).mean().reset_index</span><a id="_idTextAnchor1265"/><span class="koboSpan" id="kobo.322.1">()</span></pre><pre class="console"><span class="koboSpan" id="kobo.323.1">
data_store = train[['Week','Weekly_Sales']].groupby(['Week']).mean().reset_index</span><a id="_idTextAnchor1266"/><span class="koboSpan" id="kobo.324.1">()</span></pre><pre class="console"><span class="koboSpan" id="kobo.325.1">
data_store = data_store.merge(data_features,on=['Week'],how='left').fillna(.</span><a id="_idTextAnchor1267"/><span class="koboSpan" id="kobo.326.1">0)</span></pre><pre class="console"><span class="koboSpan" id="kobo.327.1">
data_store.head()</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.328.1">The previous code will show us the </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">merged data.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1268"/></p>
<div>
<div class="IMG---Figure" id="_idContainer229">
<span class="koboSpan" id="kobo.330.1"><img alt="Figure 9.17: Median weekly contextual data " src="image/B19026_09_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.331.1">Figure 9.17: Median weekly contextual data</span></p>
<ol>
<li value="15"><span class="koboSpan" id="kobo.332.1">We can now</span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.333.1"> use the information to construct a seaborn pair plot to visualize any relationship. </span><span class="koboSpan" id="kobo.333.2">We exclude the </span><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">Week</span></strong><span class="koboSpan" id="kobo.335.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">IsHoliday</span></strong><span class="koboSpan" id="kobo.337.1"> variables, the latter because categorical variables are difficult to visualize with this type </span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">of plo</span><a id="_idTextAnchor1269"/><span class="koboSpan" id="kobo.339.1">t:</span></span><pre class="console"><span class="koboSpan" id="kobo.340.1">
sns.pairplot(data_store.drop(['Week','IsHoliday'],axis=1))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.341.1">The code will create a plot with the relationship between the </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">numerical variables.</span></span></p>
<p class="IMG---Figure"><a id="_idTextAnchor1270"/></p>
<div>
<div class="IMG---Figure" id="_idContainer230">
<span class="koboSpan" id="kobo.343.1"><img alt="Figure 9.18: Feature pair plot " src="image/B19026_09_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.344.1">Figure 9.18: Feature pair plot</span></p>
<p><span class="koboSpan" id="kobo.345.1">We can see</span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.346.1"> that although we would be able to better appreciate the relationships, most of the weekly sales have a similar mean per week, making it difficult to differentiate meaningful relationships with CPI, unemployment, or fuel price. </span><span class="koboSpan" id="kobo.346.2">We should repeat the exercise without grouping the data, which would consequently give us more information but would take a bit more </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">processing time.</span></span></p>
<ol>
<li value="16"><span class="koboSpan" id="kobo.348.1">To predict the</span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.349.1"> sales, first, we need to manipulate the data and make some decisions. </span><span class="koboSpan" id="kobo.349.2">The first is at which level we want to make the predictions in terms of time. </span><span class="koboSpan" id="kobo.349.3">In our case, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">predict</span></strong><span class="koboSpan" id="kobo.351.1"> for weekly sales. </span><span class="koboSpan" id="kobo.351.2">We will group all the data into a single DataFrame in which each data point is enriched with information about both the store as well as the conditions of </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">that day.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.353.1">We also transform the Type column into a one-hot vector representation using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">pd.get_dummies</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.355.1"> functi</span><a id="_idTextAnchor1271"/><span class="koboSpan" id="kobo.356.1">on:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.357.1">
data = train.drop(['Year','Month','Week'],axis=1).merge(features.drop(['IsHoliday','Week'],axis=1),on=['Store','Date</span><a id="_idTextAnchor1272"/><span class="koboSpan" id="kobo.358.1">'])
data = pd.concat([data.drop(['Type'],axis=1),
      pd.get_dummies(data['Type'])],axis=1).fillna</span><a id="_idTextAnchor1273"/><span class="koboSpan" id="kobo.359.1">(0)
data['IsHoliday'] = data['IsHoliday'].astype(i</span><a id="_idTextAnchor1274"/><span class="koboSpan" id="kobo.360.1">nt)
data.head()</span></pre>
<p><span class="koboSpan" id="kobo.361.1">We can see the created columns in </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">the DataFrame.</span></span><a id="_idTextAnchor1275"/></p>
<div>
<div class="IMG---Figure" id="_idContainer231">
<span class="koboSpan" id="kobo.363.1"><img alt="Figure 9.19: Dataset with no encoded variable " src="image/B19026_09_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.364.1">Figure 9.19: Dataset with no encoded variable</span></p>
<p><span class="koboSpan" id="kobo.365.1">This configuration of data allows us to extend the exploration to the analysis of correlations between the variables, which in turn sets the stage to start using the data to </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">predict sales.</span></span></p>
<p><span class="koboSpan" id="kobo.367.1">The next block of code will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">corr()</span></strong><span class="koboSpan" id="kobo.369.1"> method of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">pandas</span></strong><span class="koboSpan" id="kobo.371.1"> DataFrame to analyze the correlation between variables, and we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">numpy</span></strong><span class="koboSpan" id="kobo.373.1"> package </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.374.1">to mask the redundant values and finally plot the data using the seaborn </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">heatmap</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.376.1"> visualizati</span><a id="_idTextAnchor1276"/><span class="koboSpan" id="kobo.377.1">on:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.378.1">
import numpy as</span><a id="_idTextAnchor1277"/><span class="koboSpan" id="kobo.379.1"> np
df_corr = data.drop(['Date'],axis=1).cor</span><a id="_idTextAnchor1278"/><span class="koboSpan" id="kobo.380.1">r()
mask = np.triu(np.ones_like(df_corr, dtype=boo</span><a id="_idTextAnchor1279"/><span class="koboSpan" id="kobo.381.1">l))
df_corr = df_corr.mask(mask).round</span><a id="_idTextAnchor1280"/><span class="koboSpan" id="kobo.382.1">(3)
fig, ax = plt.subplots(figsize=(16,16))
sns.heatmap(df_corr, annot=True,ax=ax)</span></pre>
<p><span class="koboSpan" id="kobo.383.1">The preceding code will create the correlation plot of </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">the variables.</span></span><a id="_idTextAnchor1281"/></p>
<div>
<div class="IMG---Figure" id="_idContainer232">
<span class="koboSpan" id="kobo.385.1"><img alt="Figure 9.20: Variables correlation " src="image/B19026_09_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.386.1">Figure 9.20: Variables correlation</span></p>
<p><span class="koboSpan" id="kobo.387.1">We can see</span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.388.1"> some interesting correlations, for example, the positive correlation between the size of markdown 2 and 3 and the size of the store, and the positive correlation between the size of markdown 1 </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">and 4.</span></span></p>
<ol>
<li value="17"><span class="koboSpan" id="kobo.390.1">Finally, we can show the degree of correlation between the variables and the </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">weekly sal</span><a id="_idTextAnchor1282"/><span class="koboSpan" id="kobo.392.1">es:</span></span><pre class="console"><span class="koboSpan" id="kobo.393.1">
f, ax = plt.subplots(figsize=(20, </span><a id="_idTextAnchor1283"/><span class="koboSpan" id="kobo.394.1">6))</span></pre><pre class="console"><span class="koboSpan" id="kobo.395.1">
data = df_corr['Weekly_Sales'].dropna().sort_values(ascending=Fal</span><a id="_idTextAnchor1284"/><span class="koboSpan" id="kobo.396.1">se)</span></pre><pre class="console"><span class="koboSpan" id="kobo.397.1">
sns.barplot(x=data.index,y=data)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.398.1">The following barplot will show us the most </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">correlated variables.</span></span><a id="_idTextAnchor1285"/></p>
<div>
<div class="IMG---Figure" id="_idContainer233">
<span class="koboSpan" id="kobo.400.1"><img alt="Figure 9.21: Variables correlation sorted " src="image/B19026_09_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.401.1">Figure 9.21: Variables correlation sorted</span></p>
<p><span class="koboSpan" id="kobo.402.1">We can see</span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.403.1"> that the weekly sales are highly influenced by the size of the store positively, followed by markdowns 5 and 1. </span><span class="koboSpan" id="kobo.403.2">It is negatively correlated with unemployment and </span><strong class="bold"><span class="koboSpan" id="kobo.404.1">Consumer Price Index</span></strong><span class="koboSpan" id="kobo.405.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.406.1">CPI</span></strong><span class="koboSpan" id="kobo.407.1">), which </span><span class="No-Break"><span class="koboSpan" id="kobo.408.1">makes sense.</span></span></p>
<p><span class="koboSpan" id="kobo.409.1">Now that we have a better understanding of the data, we will start the process of making predictions on </span><span class="No-Break"><span class="koboSpan" id="kobo.410.1">weekly sal</span><a id="_idTextAnchor1286"/><span class="koboSpan" id="kobo.411.1">es.</span></span></p>
<h1 id="_idParaDest-94"><a id="_idTextAnchor1287"/><span class="koboSpan" id="kobo.412.1">Predicting sales with Prophet</span></h1>
<p><span class="koboSpan" id="kobo.413.1">Forecasting a</span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.414.1"> time series can be a challenging task if there</span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.415.1"> are many different methods you can use and many different hyperparameters for each method. </span><span class="koboSpan" id="kobo.415.2">The Prophet library is an open source library designed to make predictions for univariate time series data sets. </span><span class="koboSpan" id="kobo.415.3">It is easy to use and designed to automatically find a good set of hyperparameters for the model to make competent predictions for data with standard trends and </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.416.1">seasonal structure. </span><span class="koboSpan" id="kobo.416.2">We will learn how </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.417.1">to use the Facebook Prophet package to predict the weekly sales </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">time series:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.419.1">First, we will import the library and create a dataset that contains all the features described as either continuous variables or </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">one-hot represent</span><a id="_idTextAnchor1288"/><span class="koboSpan" id="kobo.421.1">ations:</span></span><pre class="console"><span class="koboSpan" id="kobo.422.1">
from fbprophet import </span><a id="_idTextAnchor1289"/><span class="koboSpan" id="kobo.423.1">Prophet</span></pre><pre class="console"><span class="koboSpan" id="kobo.424.1">
data = train.drop(['Year','Month','Week'],axis=1).merge(features.drop(['IsHoliday','Week'],axis=1),on=['Store','</span><a id="_idTextAnchor1290"/><span class="koboSpan" id="kobo.425.1">Date'])</span></pre><pre class="console"><span class="koboSpan" id="kobo.426.1">
data = pd.concat([data.drop(['Type'],axis=1),</span></pre><pre class="console"><span class="koboSpan" id="kobo.427.1">
      pd.get_dummies(data['Type'])],axis=1).fi</span><a id="_idTextAnchor1291"/><span class="koboSpan" id="kobo.428.1">llna(0)</span></pre><pre class="console"><span class="koboSpan" id="kobo.429.1">
data['IsHoliday'] = data['IsHoliday'].astype(int)</span></pre></li>
<li><span class="koboSpan" id="kobo.430.1">Filter results for Store 1, as we will train a model that learns the behavior of each </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">specific</span><a id="_idTextAnchor1292"/><span class="koboSpan" id="kobo.432.1"> store:</span></span><pre class="console"><span class="koboSpan" id="kobo.433.1">
data = data[data.Store==1]</span></pre></li>
<li><span class="koboSpan" id="kobo.434.1">For the Prophet package, we need to prepare some expected column names with a specific data type. </span><span class="koboSpan" id="kobo.434.2">In this case, we need to pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">ds</span></strong><span class="koboSpan" id="kobo.436.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">y</span></strong><span class="koboSpan" id="kobo.438.1"> variables, the first being a </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">datetime</span></strong><span class="koboSpan" id="kobo.440.1"> type </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">of </span><a id="_idTextAnchor1293"/><span class="koboSpan" id="kobo.442.1">column:</span></span><pre class="console"><span class="koboSpan" id="kobo.443.1">
data['ds']= pd.to_datetime(data['</span><a id="_idTextAnchor1294"/><span class="koboSpan" id="kobo.444.1">Date'])</span></pre><pre class="console"><span class="koboSpan" id="kobo.445.1">
data =  data.sort_values(['ds'],ascending=</span><a id="_idTextAnchor1295"/><span class="koboSpan" id="kobo.446.1">'True')</span></pre><pre class="console"><span class="koboSpan" id="kobo.447.1">
data['y']=data['Weekly_Sales']</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.448.1">Now that we have created the columns with the proper data types, we can drop the redundant columns and show the </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">first</span><a id="_idTextAnchor1296"/><span class="koboSpan" id="kobo.450.1"> lines:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.451.1">
data = data.drop(['Date','Weekly_Sales'],axis=1).reset_index(dro</span><a id="_idTextAnchor1297"/><span class="koboSpan" id="kobo.452.1">p=True)
data.he</span><a id="_idTextAnchor1298"/><span class="koboSpan" id="kobo.453.1">ad()</span></pre>
<div>
<div class="IMG---Figure" id="_idContainer234">
<span class="koboSpan" id="kobo.454.1"><img alt="Figure 9.22: Data to be used for model training " src="image/B19026_09_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.455.1">Figure 9.22: Data to be used for model training</span></p>
<p><span class="koboSpan" id="kobo.456.1">We can </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.457.1">now split the data into train and test </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">dat</span><a id="_idTextAnchor1299"/><span class="koboSpan" id="kobo.459.1">a sets.</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.460.1">
x_train = data[</span><a id="_idTextAnchor1300"/><span class="koboSpan" id="kobo.461.1">:-1000]
x_test = data[-1000:]</span></pre>
<ol>
<li value="4"><span class="koboSpan" id="kobo.462.1">Finally, we</span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.463.1"> can define the model that we will use. </span><span class="koboSpan" id="kobo.463.2">In this case, we need to establish linear growth with multiplicative seasonality. </span><span class="koboSpan" id="kobo.463.3">In this case, we have also included </span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">weekly seas</span><a id="_idTextAnchor1301"/><span class="koboSpan" id="kobo.465.1">onality:</span></span><pre class="console"><span class="koboSpan" id="kobo.466.1">
model = Prophet(changepoint_prior_scale=0.05, </span></pre><pre class="console"><span class="koboSpan" id="kobo.467.1">
            interval_width=0.95,</span></pre><pre class="console"><span class="koboSpan" id="kobo.468.1">
            growth = 'linear',</span></pre><pre class="console"><span class="koboSpan" id="kobo.469.1">
            seasonality_mode = 'multiplica</span><a id="_idTextAnchor1302"/><span class="koboSpan" id="kobo.470.1">tive',</span></pre><pre class="console"><span class="koboSpan" id="kobo.471.1">
            weekly_seasonality</span><a id="_idTextAnchor1303"/><span class="koboSpan" id="kobo.472.1">=True,</span></pre><pre class="console"><span class="koboSpan" id="kobo.473.1">
            changepoint_range=0.9)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.474.1">Before training the forecaster, we can add regressors that use the </span><span class="No-Break"><span class="koboSpan" id="kobo.475.1">additional variables.</span></span></p>
<p><span class="koboSpan" id="kobo.476.1">Here, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">add_regressor</span></strong><span class="koboSpan" id="kobo.478.1"> argument is the column name of the additional variable in the </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">trai</span><a id="_idTextAnchor1304"/><span class="koboSpan" id="kobo.480.1">ning DataFrame:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.481.1">
for c in ['Dept','IsHoliday',
      'CPI','Fuel_Price','MarkDown1',
'MarkDown2','MarkDown3','MarkDown4','MarkDown5', 'Unemplo</span><a id="_idTextAnchor1305"/><span class="koboSpan" id="kobo.482.1">yment']:
  </span><a id="_idTextAnchor1306"/><span class="koboSpan" id="kobo.483.1">print(c)
  model.add_regressor(name=c, prior_scale=None, standardize='auto', mode='additive')</span></pre>
<p><span class="koboSpan" id="kobo.484.1">Note that</span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.485.1"> here we are adding additional</span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.486.1"> variables as regressors to the model. </span><span class="koboSpan" id="kobo.486.2">These variables should have values for your future (test) data. </span><span class="koboSpan" id="kobo.486.3">One key factor is that we are using the same parameters for all of the variables, while fine-tuning these parameters for each one of the variables is advised instead of this method. </span><span class="koboSpan" id="kobo.486.4">Although, the selection of each one of these parameters in consideration of the specifics of each variable is beyond the scope of </span><span class="No-Break"><span class="koboSpan" id="kobo.487.1">this analysis.</span></span></p>
<p><span class="koboSpan" id="kobo.488.1">Finally, we can fit </span><a id="_idTextAnchor1307"/><span class="No-Break"><span class="koboSpan" id="kobo.489.1">the model:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.490.1">
model.fit(data[['ds','y','Dept','IsHoliday','CPI',
'Fuel_Price','MarkDown1','MarkDown2','MarkDown3',
'MarkDown4','MarkDown5', 'Unemployment']])</span></pre>
<ol>
<li value="5"><span class="koboSpan" id="kobo.491.1">After the model has been trained, we can use it to make forecasts on the test data to evaluate the performance of </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">the p</span><a id="_idTextAnchor1308"/><span class="koboSpan" id="kobo.493.1">rediction:</span></span><pre class="console"><span class="koboSpan" id="kobo.494.1">
forecast = model.predict(x_test[['ds','Dept','IsHoliday','</span></pre><pre class="console"><span class="koboSpan" id="kobo.495.1">
CPI','Fuel_Price','MarkDown1','MarkDown2','MarkDown3',</span></pre><pre class="console"><span class="koboSpan" id="kobo.496.1">
'MarkDown4','MarkDown5', 'Unemployment']])</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.497.1">We can access the resulting forecast that shows us the predicted values for each date, along with the upper and </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">lower b</span><a id="_idTextAnchor1309"/><span class="koboSpan" id="kobo.499.1">oundaries:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.500.1">
print(forecast[['ds', 'yhat', 'yhat_lower', 
      'yhat_upper']].</span><a id="_idTextAnchor1310"/><span class="koboSpan" id="kobo.501.1">head())</span></pre>
<div>
<div class="IMG---Figure" id="_idContainer235">
<span class="koboSpan" id="kobo.502.1"><img alt="Figure 9.23: Forecasted data " src="image/B19026_09_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.503.1">Figure 9.23: Forecasted data</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.504.1">Now, we can concatenate these results with the actual values for y in the test data to visualize </span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.505.1">the results. </span><span class="koboSpan" id="kobo.505.2">The resulting curves are softened using a rolling average </span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.506.1">with a window of seven lags for </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">visualizatio</span><a id="_idTextAnchor1311"/><span class="koboSpan" id="kobo.508.1">n purposes:</span></span><pre class="console"><span class="koboSpan" id="kobo.509.1">
forecast_data = pd.concat([forecast[['yhat', </span></pre><pre class="console"><span class="koboSpan" id="kobo.510.1">
'yhat_lower', 'yhat_upper']],</span></pre><pre class="console"><span class="koboSpan" id="kobo.511.1">
x_test['y'].reset_index(drop=Tru</span><a id="_idTextAnchor1312"/><span class="koboSpan" id="kobo.512.1">e)],axis=1)</span></pre><pre class="console"><span class="koboSpan" id="kobo.513.1">
forecast_data.rolling(window=7).mean().plot(figsize=(20,8))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.514.1">The preceding code will generate a visualization where we can see the actual sales versus the </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">actual </span><a id="_idTextAnchor1313"/><span class="koboSpan" id="kobo.516.1">results.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer236">
<span class="koboSpan" id="kobo.517.1"><img alt="Figure 9.24: Forecasted data against actual values " src="image/B19026_09_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.518.1">Figure 9.24: Forecasted data against actual values</span></p>
<p><span class="koboSpan" id="kobo.519.1">We can see that, apart from certain cases, most of the time the predicted value has been close to the actual values, in rare times surpassing the upper boundary but never </span><a id="_idTextAnchor1314"/><span class="No-Break"><span class="koboSpan" id="kobo.520.1">the lower.</span></span></p>
<h1 id="_idParaDest-95"><a id="_idTextAnchor1315"/><span class="koboSpan" id="kobo.521.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.522.1">In this chapter, we have dived into the details of sales analysis and markdown applications. </span><span class="koboSpan" id="kobo.522.2">As discussed, there is a trade-off between reducing the price of items to increase sales and reduce stock-related costs and the amount of revenue that is lost due to that decrease in price. </span><span class="koboSpan" id="kobo.522.3">In the case of retail, these outcomes are impacted by multiple factors, among which are the location of a given store, the environmental and economic conditions, and seasonality, as we saw with the analysis of sales during different </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">holiday seasons.</span></span></p>
<p><span class="koboSpan" id="kobo.524.1">The analysis and prediction of sales and markdowns can be applied to fine-tune the price reductions applied to maintain the equilibrium between profitability and sales, as well as to have a deep understanding of the variables involved and their relative impact that can lead to the design of better </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1">markdown strategies.</span></span></p>
<p><span class="koboSpan" id="kobo.526.1">In the next chapter, we will dive into the specifics of learning the consumer behavior at e-commerce retailers, understanding consumer segmentation, predicting consumer lifetime value, and predicting which users will </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">eventually buy.</span></span></p>
</div>
</body></html>