<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer060">
			<h1 id="_idParaDest-143"><em class="italic"><a id="_idTextAnchor156"/>Chapter 6</em>: Creating Your First Pipeline</h1>
			<p>In <a href="B17085_03_Final_SB_Epub.xhtml#_idTextAnchor055"><em class="italic">Chapter 3</em></a>, <em class="italic">Pachyderm Pipeline Specification</em>, we learned about the Pachyderm pipeline specification and what parameters you can configure in it. The pipeline specification is the most critical configuration piece of your pipeline, along with your code. In this chapter, we will learn how to create a Pachyderm pipeline that performs image processing. We will walk through all the steps that are involved in this process, including creating the Pachyderm repository, creating a pipeline, viewing the results of our computations, and adding an extra step to our original pipeline.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Pipeline overview</li>
				<li>Creating a repository</li>
				<li>Creating a pipeline specification</li>
				<li>Viewing the pipeline result</li>
				<li>Adding another pipeline step</li>
			</ul>
			<h1 id="_idParaDest-144"><a id="_idTextAnchor157"/>Technical requirements</h1>
			<p>This chapter requires that you have access to the following components and that they are installed and configured.</p>
			<p>For a local macOS installation, you will need the following:</p>
			<ul>
				<li>macOS Mojave, Catalina, Big Sur, or later</li>
				<li>Docker Desktop for Mac 10.14</li>
				<li><strong class="source-inline">minikube</strong> v1.19.0 or later</li>
				<li><strong class="source-inline">pachctl</strong> 2.0.x or later</li>
				<li>Pachyderm 2.0.x or later</li>
			</ul>
			<p>For a local Windows installation, you will need the following:</p>
			<ul>
				<li>Windows Pro 64-bit v10 or later</li>
				<li><strong class="bold">Windows Subsystem for Linux</strong> (<strong class="bold">WSL</strong>) 2 or later</li>
				<li>Microsoft Powershell v6.2.1 or later</li>
				<li>Hyper-V </li>
				<li><strong class="source-inline">minikube</strong> v1.19.0 or later</li>
				<li><strong class="source-inline">kubectl</strong> v1.18 or later</li>
				<li><strong class="source-inline">pachctl</strong> 2.0.x or later</li>
				<li>Pachyderm 2.0.x or later</li>
			</ul>
			<p>For an <strong class="bold">Amazon Elastic Kubernetes Service</strong> (<strong class="bold">Amazon EKS</strong>) installation, you will need the following:</p>
			<ul>
				<li><strong class="source-inline">kubectl</strong> v.18 or later</li>
				<li><strong class="source-inline">eksctl</strong></li>
				<li><strong class="source-inline">aws-iam-authenticator</strong></li>
				<li><strong class="source-inline">pachctl</strong> 2.0.x or later</li>
				<li>Pachyderm 2.0.x or later</li>
			</ul>
			<p>For a Microsoft Azure cloud installation, you will need the following:</p>
			<ul>
				<li><strong class="source-inline">kubectl</strong> v.18 or later</li>
				<li>The Azure CLI</li>
				<li><strong class="source-inline">pachctl</strong> 2.0.x or later</li>
				<li>Pachyderm 2.0.x or later</li>
				<li><strong class="source-inline">jq</strong> 1.5 or later</li>
			</ul>
			<p>For a <strong class="bold">Google Kubernetes Engine</strong> (<strong class="bold">GKE</strong>) cloud installation, you will need the following:</p>
			<ul>
				<li>Google Cloud SDK v124.0.0. or later</li>
				<li><strong class="source-inline">kubectl</strong> v.18 or later</li>
				<li><strong class="source-inline">pachctl</strong> 2.0.x or later</li>
				<li>Pachyderm 2.0.x or later</li>
			</ul>
			<p>You do not need any special hardware to be able to run the pipelines in this chapter. If you are running your Pachyderm cluster locally, any modern laptop should support all the operations in this chapter. If you are running Pachyderm in a cloud platform, you will need to have a <strong class="bold">Persistent Volume</strong> (<strong class="bold">PV</strong>). See <a href="B17085_05_Final_SB_Epub.xhtml#_idTextAnchor123"><em class="italic">Chapter 5</em></a>, <em class="italic">Installing Pachyderm on a Cloud Platform</em>, for more details.</p>
			<p>All the scripts and data described in this chapter are available at <a href="https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/tree/main/Chapter06-Creating-Your-First-Pipeline">https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/tree/main/Chapter06-Creating-Your-First-Pipeline</a>.</p>
			<p>Now that we have reviewed the technical requirements for this chapter, let's take a closer look at our pipeline.</p>
			<h1 id="_idParaDest-145"><a id="_idTextAnchor158"/>Pipeline overview</h1>
			<p>In <a href="B17085_04_Final_SB_Epub.xhtml#_idTextAnchor096"><em class="italic">Chapter 4</em></a>, <em class="italic">Installing Pachyderm Locally</em>, and <a href="B17085_05_Final_SB_Epub.xhtml#_idTextAnchor123"><em class="italic">Chapter 5</em></a>, <em class="italic">Installing Pachyderm on a Cloud Platform</em>, we learned how to deploy Pachyderm locally or on a cloud platform. By now, you <a id="_idIndexMarker576"/>should have some version of Pachyderm up and running, either on your computer or a cloud platform. Now, let's create our first pipeline.</p>
			<p>A Pachyderm pipeline<a id="_idIndexMarker577"/> is a technique that processes data from a Pachyderm input repository or repositories and uploads it to a Pachyderm output repository. Every time new data is uploaded to the input repository, the pipeline automatically processes it. Every time new data lands in the repository, it is recorded as a commit hash and can be accessed, rerun, or analyzed later. Therefore, a pipeline is an essential component of the Pachyderm ecosystem that ensures the reproducibility of your data science workloads.</p>
			<p>To get you started quickly, we have prepared a simple example of image processing that will draw a contour on an image. A contour is an outline that represents the shape of an object. This is a useful technique that is often applied to image processing pipelines. </p>
			<p>Image processing is a <a id="_idIndexMarker578"/>widely used technique that enables you to enhance the quality of images, transform an image into another image, extract various<a id="_idIndexMarker579"/> information about an image, and so on. With machine learning, you can set up pipelines that can determine objects in an image, create a histogram of an image, and so on.</p>
			<p>There are many open source libraries that you can use for advanced image processing, with the most famous<a id="_idIndexMarker580"/> among them being <strong class="bold">OpenCV</strong> and <strong class="bold">scikit-image</strong>. Both of these libraries are widely used by machine learning experts for various image processing tasks.</p>
			<p>For this example, we will use scikit-image. Scikit-image, or <strong class="source-inline">skimage</strong>, is an open-source image processing library that<a id="_idIndexMarker581"/> enables you to run various image processing algorithms to analyze and transform images. Scikit-image is built to work with the Python programming language.</p>
			<p>In this example, we will use scikit-image with a couple of other open source components, including the following:</p>
			<ul>
				<li><strong class="bold">NumPy</strong>: An open <a id="_idIndexMarker582"/>source Python library that enables you to work with arrays. When you need to analyze or segment an image, it must be transformed into an array for processing.</li>
				<li><strong class="bold">Matplotlib</strong>: An<a id="_idIndexMarker583"/> extension to NumPy that enables you to plot images and create data visualizations.</li>
			</ul>
			<p>We will create a pipeline that will consume the data from the <strong class="source-inline">photos</strong> repository, run a <strong class="source-inline">contour.py</strong> script against the images in the <strong class="source-inline">photos</strong> repository, and upload the result to the <strong class="source-inline">contour</strong> output repository.</p>
			<p>The following diagram explains our pipeline:</p>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="Images/B17085_06_001.jpg" alt="" width="1186" height="251"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.1 – Contour pipeline</p>
			<p>The <a id="_idIndexMarker584"/>following code explains the <strong class="source-inline">contour.py</strong> script:</p>
			<p class="source-code">import numpy as np</p>
			<p class="source-code">import matplotlib.pyplot as plt</p>
			<p class="source-code">import os</p>
			<p class="source-code">from skimage.io import imread, imsave</p>
			<p class="source-code">from skimage import measure</p>
			<p class="source-code">import logging</p>
			<p class="source-code">logging.basicConfig(level=logging.INFO)</p>
			<p class="source-code">def create_contours(photo):</p>
			<p class="source-code">     image = imread(photo, as_gray=True)</p>
			<p class="source-code">     t = os.path.split(photo)[1]</p>
			<p class="source-code">     c = measure.find_contours(image, 0.9)</p>
			<p class="source-code">     fig, ax = plt.subplots()</p>
			<p class="source-code">     ax.imshow(image, vmin=-1, vmax=1, cmap='gray')</p>
			<p class="source-code">     for contour in c:</p>
			<p class="source-code">         ax.plot(contour[:, 1], contour[:, 0], linewidth=2)</p>
			<p class="source-code">     ax.axis('image')</p>
			<p class="source-code">     ax.set_xticks([])</p>
			<p class="source-code">     ax.set_yticks([])</p>
			<p class="source-code">     plt.savefig(os.path.join("/pfs/out", os.path.splitext(t)[0]+'.png'))</p>
			<p class="source-code">for dirpath, dirnames, filenames in os.walk("/pfs/photos"):</p>
			<p class="source-code">     for f in filenames:</p>
			<p class="source-code">         create_contours(os.path.join(dirpath, f))</p>
			<p>The preceding script contains a function called <strong class="source-inline">create_contours</strong>. This function does the following:</p>
			<ol>
				<li value="1">First, it<a id="_idIndexMarker585"/> reads the image file from the <strong class="source-inline">pfs/photos</strong> repository and converts it into a grayscale image. This is needed to transform a color image (RGB) into a two-dimensional NumPy array.</li>
				<li>Then, it uses the <strong class="source-inline">measure.find_contours</strong> API method from the <strong class="source-inline">skimage.measure.find_contours</strong> module to find the contour of the two-dimensional array that we converted our image into at a value of 0.9. This value represents the position between light and dark tones. Typically, it's best to use a middle value, but in this case, 0.9 created the best results.</li>
				<li>Then, it defined subplots to visualize our image and saved it in the <strong class="source-inline">pfs/out</strong> directory, which, in reality, will be the <strong class="source-inline">pfs/out/contour</strong> output repository.</li>
				<li>The last part of the script tells the program to apply the <strong class="source-inline">create_contours</strong> function to all the files in the <strong class="source-inline">pfs/photos</strong> repository. </li>
			</ol>
			<p>This script is built into a Docker image that we will use to run our pipeline. This Docker image is hosted in Docker Hub.</p>
			<p>We will use the following images from freepik.com for processing. The first image is an image of a brown vase:</p>
			<div>
				<div id="_idContainer045" class="IMG---Figure">
					<img src="Images/B17085_06_002.jpg" alt="" width="843" height="309"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.2 – Brown vase </p>
			<p>The second<a id="_idIndexMarker586"/> image is an image of a hand:</p>
			<div>
				<div id="_idContainer046" class="IMG---Figure">
					<img src="Images/B17085_06_003.jpg" alt="" width="892" height="282"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.3 – Hand</p>
			<p>Finally, the third image is an image of a landscape:</p>
			<div>
				<div id="_idContainer047" class="IMG---Figure">
					<img src="Images/B17085_06_004.jpg" alt="" width="627" height="417"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.4 – Landscape</p>
			<p>As you can<a id="_idIndexMarker587"/> see, these are some simple images where finding the contours should be easy. You can try to run this pipeline against more complex images and see the results you'll get. In general, the more contrast you have between the elements in the image, the more precise contours the algorithm will be able to find.</p>
			<p>Now that we understand the example we are working on, let's go ahead and create a repository.</p>
			<h1 id="_idParaDest-146"><a id="_idTextAnchor159"/>Creating a repository</h1>
			<p>The first step in <a id="_idIndexMarker588"/>creating your pipeline is to create a Pachyderm repository and put some data in it. As you probably remember from <a href="B17085_02_Final_SB_Epub.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Pachyderm Basics</em>, a Pachyderm repository is a location inside of a Pachyderm cluster where you store your data. We will be creating an input repository, and the pipeline will automatically create an output repository on the first run.</p>
			<p>To create an input repository, perform the following steps:</p>
			<ol>
				<li value="1">Log into your Terminal.</li>
				<li>Verify that Pachyderm is up and running:<p class="source-code"><strong class="bold">% pachctl version</strong></p></li>
			</ol>
			<p>You should see an output similar to the following:</p>
			<p class="source-code">COMPONENT           VERSION</p>
			<p class="source-code">pachctl             2.0.0</p>
			<p class="source-code">pachd               2.0.0</p>
			<p>The <strong class="source-inline">pachd</strong> component must list a version.</p>
			<ol>
				<li value="3">Create a Pachyderm input repository called <strong class="source-inline">photos</strong>:<p class="source-code"><strong class="bold">% pachctl create repo photos</strong></p></li>
			</ol>
			<p>No output will be returned.</p>
			<ol>
				<li value="4">Verify <a id="_idIndexMarker589"/>that the <strong class="source-inline">photos</strong> repository was created:<p class="source-code"><strong class="bold">% pachctl list repo</strong></p></li>
			</ol>
			<p>You should see the following output:</p>
			<p class="source-code">NAME   CREATED        SIZE (MASTER) ACCESS LEVEL</p>
			<p class="source-code">photos 11 seconds ago ≤ 0B          [repoOwner]</p>
			<p>Here, you can see that the <strong class="source-inline">photos</strong> repository was created and that it is empty. Although the size is counted for the master branch, at this point, no branches exist in this repository. Pachyderm will automatically create a specified branch when you put files in it.</p>
			<ol>
				<li value="5">Put some images in the <strong class="source-inline">photos</strong> repository. We need to put the files into the root of our <strong class="source-inline">photos</strong> repository. To do this, you need to use the <strong class="source-inline">-r</strong> (recursive) flag and specify the path to the directory that contains the files on your computer. For example, if you have downloaded the files to a data folder on your computer, you need to run the following command: <p class="source-code"><strong class="bold">% pachctl put file -r photos@master:/ -f data</strong></p></li>
			</ol>
			<p>The following is some sample output:</p>
			<p class="source-code">data/brown_vase.png 25.82 KB / 25.82 KB [=====] 0s 0.00 b/s</p>
			<p class="source-code">data/hand.png 33.21 KB / 33.21 KB [======] 0s 0.00 b/s</p>
			<p class="source-code">data/landscape.png 54.01 KB / 54.01 KB [=========] 0s</p>
			<p>Pachyderm automatically creates the specified branch. In this example, Pachyderm creates the <strong class="source-inline">master</strong> branch. You could name the branch anything you want, but for simplicity, let's call it <strong class="source-inline">master</strong>. All the commands in this section are written with the <strong class="source-inline">master</strong> branch in mind.</p>
			<ol>
				<li value="6">Verify that <a id="_idIndexMarker590"/>the files were added to the repository:<p class="source-code"><strong class="bold">% pachctl list file photos@master</strong></p></li>
			</ol>
			<p>The following is some sample output:</p>
			<p class="source-code">NAME           TYPE SIZE</p>
			<p class="source-code">/brown_vase.png file 25.21KiB</p>
			<p class="source-code">/hand.png       file 32.43KiB</p>
			<p class="source-code">/landscape.png  file 52.74KiB </p>
			<ol>
				<li value="7">Alternatively, you could place each file one by one by running the <strong class="source-inline">pachctl put file</strong> command for each image. For example, to place the <strong class="source-inline">landscape.jpg</strong> file, change the directory on your computer to <strong class="source-inline">data</strong> and use the following command:<p class="source-code"><strong class="bold">% pachctl put file photos@master -f landscape.jpg</strong></p></li>
			</ol>
			<p>The following is some sample output:</p>
			<p class="source-code">data/landscape.jpg 54.01KB / 54.01 KB [=] 0s 0.00 b/s/ </p>
			<p>Repeat this<a id="_idIndexMarker591"/> command for all image files.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Make sure that the <strong class="source-inline">TYPE</strong> parameter in the output says <strong class="source-inline">file</strong> and not <strong class="source-inline">dir</strong>. Pachyderm does not distinguish between directories and files, and you use <strong class="source-inline">-f</strong> to put files in a directory or the root of the repository. If any of your files are listed as <strong class="source-inline">dir</strong>, you need to delete them by running <strong class="source-inline">pachctl delete file photos@master:&lt;path&gt;</strong> and start over. The pipeline will not work as expected if you place the files in the directories.</p>
			<p>Now that we have created a repository, let's create our pipeline specification.</p>
			<h1 id="_idParaDest-147"><a id="_idTextAnchor160"/>Creating a pipeline specification</h1>
			<p>In the <em class="italic">Creating a repository</em> section, we <a id="_idIndexMarker592"/>created a repository called <strong class="source-inline">photos</strong> and put some test files in it. The pipeline specification for this example must reference the following elements:</p>
			<ul>
				<li>An input repository with data to process</li>
				<li>A computer program or a script that needs to run against your data</li>
				<li>A glob pattern that specifies the datum granularity</li>
				<li>A Docker image with built-in dependencies that contains your code</li>
			</ul>
			<p>We have created a pipeline specification for you so that you can use it to create the pipeline. Here is what is in <a id="_idIndexMarker593"/>the pipeline specification file in the <strong class="bold">YAML Ain't Markup Language</strong> (<strong class="bold">YAML</strong>) format:</p>
			<p class="source-code">---</p>
			<p class="source-code"> pipeline:</p>
			<p class="source-code">   name: contour</p>
			<p class="source-code"> description: A pipeline that identifies contours on an image.</p>
			<p class="source-code"> transform:</p>
			<p class="source-code">   cmd:</p>
			<p class="source-code">   - python3</p>
			<p class="source-code">   - "/contour.py"</p>
			<p class="source-code">   image: svekars/contour-histogram:1.0</p>
			<p class="source-code">input:</p>
			<p class="source-code">   pfs:</p>
			<p class="source-code">     repo: photos</p>
			<p class="source-code">     glob: "/"</p>
			<p>Let's look at the <a id="_idIndexMarker594"/>pipeline specification in more detail. Here are the parameters in the pipeline:</p>
			<div>
				<div id="_idContainer048" class="IMG---Figure">
					<img src="Images/Table_01.jpg" alt="" width="1637" height="1290"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.5 – Contour pipeline parameters</p>
			<p>This pipeline <a id="_idIndexMarker595"/>specification does not include any optimization or other extra parameters. It is a minimum pipeline that will do the required computation for our example.</p>
			<p>To create a pipeline, perform the following steps:</p>
			<ol>
				<li value="1">Log into your terminal.</li>
				<li>Create the <strong class="source-inline">contour</strong> pipeline by running the following command:<p class="source-code"><strong class="bold">% pachctl create pipeline -f contour.yaml</strong></p></li>
			</ol>
			<p>No output will be returned.</p>
			<ol>
				<li value="3">Verify that the pipeline has been created:<p class="source-code"><strong class="bold">% pachctl list pipeline</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">NAME    VERSION INPUT    CREATED       STATE / LAST JOB   DESC</p>
			<p class="source-code">contour 1       photos:/* 5 seconds ago running / - A pipeline that identifies contours on an image.</p>
			<p>As soon as you<a id="_idIndexMarker596"/> create the pipeline, it will set its status to <strong class="source-inline">running</strong> and attempt to process the data in the input repository. You might also see that <strong class="source-inline">LAST JOB</strong> is set to starting or running.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Another important thing in the preceding output is the pipeline version. The version of our pipeline is <strong class="source-inline">1</strong>. If you change anything in your pipeline's YAML file and update your pipeline after that, the version counter will be updated to a subsequent number.</p>
			<ol>
				<li value="4">View the job that has been started for your pipeline:<p class="source-code"><strong class="bold">pachctl list job</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">ID       SUBJOBS PROGRESS CREATED       MODIFIED</p>
			<p class="source-code">71169d…  1                      2 minutes ago 2 minutes ago</p>
			<p>The output of the <strong class="source-inline">pachctl list job</strong> command gives us the following information:</p>
			<div>
				<div id="_idContainer049" class="IMG---Figure">
					<img src="Images/Table_02.jpg" alt="" width="1650" height="672"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.6 – Pipeline output explained</p>
			<p>Now that our pipeline has run successfully, let's see the output in the output repository.</p>
			<h1 id="_idParaDest-148"><a id="_idTextAnchor161"/>Viewing the pipeline result</h1>
			<p>Once your pipeline has <a id="_idIndexMarker597"/>finished running, you can view the result in the output repository. We will look at the output result in both the command line and the Pachyderm dashboard for visibility.</p>
			<p>If you are using a local Pachyderm deployment with minikube, you need to enable port-forwarding before you can access the Pachyderm UI.</p>
			<p>To view the pipeline result in the terminal, perform the following steps:</p>
			<ol>
				<li value="1">Log into your terminal.</li>
				<li>Verify that the output repository called <strong class="source-inline">contour</strong> has been created:<p class="source-code"><strong class="bold">% pachctl list repo</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">% pachctl list repo</p>
			<p class="source-code">NAME    CREATED            SIZE (MASTER) ACCESS LEVEL</p>
			<p class="source-code">contour About a minute ago ≤ 117.6KiB    [repoOwner]  Output repo for pipeline contour.</p>
			<p class="source-code">photos  5 minutes ago      ≤ 110.4KiB    [repoOwner] B</p>
			<p>As you can see, the <strong class="source-inline">contour</strong> repository has been created, and it contains 117.6 KiB of data. If you are running Pachyderm locally, you can also preview what those files look like by running one of the following commands.</p>
			<ol>
				<li value="3">If you are on macOS, run the following command to list the files in the output repository:<p class="source-code"><strong class="bold">% pachctl list file contour@master</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">NAME             TYPE SIZE</p>
			<p class="source-code">/brown_vase.png file 23.78KiB</p>
			<p class="source-code">/hand.png       file 29.79KiB</p>
			<p class="source-code">/landscape.png  file 64.08Kib </p>
			<ol>
				<li value="4">Now, pipe <a id="_idIndexMarker598"/>the <strong class="source-inline">open</strong> command to the <strong class="source-inline">pachctl get file</strong> command to open one of the images in the default preview application on your Mac. For example, to preview <strong class="source-inline">hand.png</strong>, run the following command:<p class="source-code"><strong class="bold">% pachctl get file contour@master:hand.png | open -f -a Preview.app</strong></p></li>
			</ol>
			<p>You should see the following output:</p>
			<p class="figure-caption">  </p>
			<div>
				<div id="_idContainer050" class="IMG---Figure">
					<img src="Images/B17085_06_007.jpg" alt="" width="1183" height="371"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.7 – Hand processed</p>
			<p>Now, let's <a id="_idIndexMarker599"/>view the processed results in the UI. If you are running Pachyderm on a cloud provider, just point your browser to the IP address where the Pachyderm dashboard is running. If you are running Pachyderm in Pachyderm Hub, follow the instructions in Pachyderm Hub to access the console. If you are running Pachyderm locally in minikube, follow the remaining steps to enable port-forwarding. </p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Unless you are running your experiments in Pachyderm Hub, the Pachyderm console is only available if you have deployed it. You need to have a trial or an enterprise license to deploy the Pachyderm console locally or in the cloud. </p>
			<ol>
				<li value="5">Open a separate terminal window.</li>
				<li>Enable port forwarding for your local Pachyderm deployment by running the following command:<p class="source-code"><strong class="bold">% pachctl port-forward</strong></p></li>
			</ol>
			<p>You should see the following output:</p>
			<p class="source-code">Forwarding the pachd (Pachyderm daemon) port...</p>
			<p class="source-code">listening on port 30650</p>
			<p class="source-code">Forwarding the pachd (Pachyderm daemon) port...</p>
			<p class="source-code">listening on port 30650</p>
			<p class="source-code">Forwarding the OIDC callback port...</p>
			<p class="source-code">listening on port 30657</p>
			<p class="source-code">Forwarding the s3gateway port...</p>
			<p class="source-code">listening on port 30600</p>
			<p class="source-code">Forwarding the identity service port...</p>
			<p class="source-code">listening on port 30658</p>
			<p class="source-code">Forwarding the dash service port...</p>
			<p class="source-code">...</p>
			<p>If you have used the default settings, the Pachyderm dashboard must load at http://localhost:30080.</p>
			<ol>
				<li value="7">Paste the <a id="_idIndexMarker600"/>dashboard IP address into a web browser.</li>
				<li>If you are prompted to log in, follow the onscreen instructions to do so. When you log in, you should see the following screen:</li>
			</ol>
			<div>
				<div id="_idContainer051" class="IMG---Figure">
					<img src="Images/B17085_06_008.jpg" alt="" width="682" height="156"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.8 – Pachyderm Direct Acyclic Graph (DAG)</p>
			<p>This is a <strong class="bold">Direct Acyclic Graph</strong> (<strong class="bold">DAG</strong>) that's<a id="_idIndexMarker601"/> been created for the input and output repositories, as well as the pipeline.</p>
			<ol>
				<li value="9">Click on the contour output repository (the last one on the screen) and then click <strong class="bold">View Files</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer052" class="IMG---Figure">
					<img src="Images/B17085_06_009.jpg" alt="" width="848" height="575"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.9 – Output repository information</p>
			<p>A list of<a id="_idIndexMarker602"/> files will appear.</p>
			<ol>
				<li value="10">Click <strong class="bold">Preview</strong> next to <strong class="source-inline">hand.png</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer053" class="IMG---Figure">
					<img src="Images/B17085_06_010.jpg" alt="" width="730" height="526"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.10 – Output file</p>
			<p>You can preview all the resulting files from the UI in the same way. From here, the files can be either consumed by another pipeline or served outside of Pachyderm through an S3 Gateway, or the output repository can be mounted and accessible on a local disk. Let's look at what the other images should look like.</p>
			<p>You should<a id="_idIndexMarker603"/> see that the landscape image has changed, as follows:</p>
			<div>
				<div id="_idContainer054" class="IMG---Figure">
					<img src="Images/B17085_06_011.jpg" alt="" width="547" height="369"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.11 – Processed landscape image</p>
			<p>The <strong class="source-inline">brown_vase.png</strong> image should look like this:</p>
			<div>
				<div id="_idContainer055" class="IMG---Figure">
					<img src="Images/B17085_06_012.jpg" alt="" width="354" height="567"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.12 – Processed vase image </p>
			<p>In this section, we learned how to view the results of a pipeline. Now, let's add another pipeline step.</p>
			<h1 id="_idParaDest-149"><a id="_idTextAnchor162"/>Adding another pipeline step</h1>
			<p>Pachyderm pipelines<a id="_idIndexMarker604"/> can be chained into multi-step workflows. For each step, you will need to have a separate pipeline specification and a Docker image if you are using one. In this section, we will add another step to our image processing workflow. We will use the <strong class="source-inline">skimage.exposure.histogram</strong> module to create histograms of all the images we have in our <strong class="source-inline">contour</strong> output repository.</p>
			<h3>Example overview</h3>
			<p>A histogram<a id="_idIndexMarker605"/> is a visual representation of data that provides information about the image, such as the number of pixels, their intensity, and other information. Because we represent images as numerical data, we can create a histogram for each of the images we processed in the first step of our workflow – the contour pipeline. In this new step of the workflow, we will create histograms for each image that has landed in the <strong class="source-inline">contour</strong> output repository and save them in the <strong class="source-inline">histogram</strong> output repository in PNG format.</p>
			<p>Here is an example of a histogram<a id="_idIndexMarker606"/> that has been generated for the <strong class="source-inline">hand.png</strong> image:</p>
			<div>
				<div id="_idContainer056" class="IMG---Figure">
					<img src="Images/B17085_06_013.jpg" alt="" width="1137" height="876"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.13 – Grayscale image histogram</p>
			<p>The <strong class="bold">y-axis</strong> represents <a id="_idIndexMarker607"/>the count of pixels, while<a id="_idIndexMarker608"/> the <strong class="bold">x-axis</strong> represents the intensity of the pixels.</p>
			<p>Here is a diagram of the new two-step workflow, which includes the contour and histogram <a id="_idIndexMarker609"/>pipelines:</p>
			<div>
				<div id="_idContainer057" class="IMG---Figure">
					<img src="Images/B17085_06_014.jpg" alt="" width="1168" height="655"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.14 – Contour and histogram workflow</p>
			<p>The <strong class="source-inline">histogram</strong> pipeline will consume the files from the <strong class="source-inline">contour</strong> repository, create histograms for them, and output them to the <strong class="source-inline">histogram</strong> repository.</p>
			<h3>Histogram creation script overview</h3>
			<p>In this <a id="_idIndexMarker610"/>pipeline step, we will use <strong class="source-inline">histogram.yaml</strong>, which will create a pipeline for us. The pipeline will run the <strong class="source-inline">histogram.py</strong> script.</p>
			<p>Let' review the <strong class="source-inline">histogram.py</strong> script, which creates histograms from the file in the <strong class="source-inline">contour</strong> repository:</p>
			<p class="source-code">from skimage import io</p>
			<p class="source-code">import matplotlib.pyplot as plt</p>
			<p class="source-code">import numpy as np</p>
			<p class="source-code">import os</p>
			<p class="source-code">def create_histogram(photo):</p>
			<p class="source-code">    image = io.imread(photo)</p>
			<p class="source-code">    t = os.path.split(photo)[1]</p>
			<p class="source-code">    plt.hist(image.ravel(), bins=np.arange(10, 70),  color='blue', alpha=0.5, rwidth=0.7)</p>
			<p class="source-code">    plt.yscale('log')</p>
			<p class="source-code">    plt.margins(x=0.03, y=-0.05)</p>
			<p class="source-code">    plt.xlabel('Intensity')</p>
			<p class="source-code">    plt.ylabel('Count')</p>
			<p class="source-code">    plt.savefig(os.path.join("/pfs/out", os.path.splitext(t)[0]+'.png'))</p>
			<p class="source-code">for dirpath, dirnames, filenames in os.walk("/pfs/contour"):</p>
			<p class="source-code">    for f in filenames:</p>
			<p class="source-code">        create_histogram(os.path.join(dirpath, f))</p>
			<p>This script<a id="_idIndexMarker611"/> imports the following libraries:</p>
			<ul>
				<li><strong class="source-inline">skimage.io</strong>: The <strong class="source-inline">io</strong> module from the scikit-image library enables read and write operations within your Python file. We need this module to read files from the contour repository.</li>
				<li><strong class="source-inline">matploit.pyplot</strong>: This Matplotlib interface enables us to plot our images. We use it to create the histogram, add labels to the x- and y-axis of the plot, and so on.</li>
				<li><strong class="source-inline">numpy</strong>: We need NumPy to represent the image as an array and keep the number of bins in the required range.</li>
				<li><strong class="source-inline">os</strong>: The <strong class="source-inline">os</strong> module from the standard Python library enables read and write operations with files. We need this module to read images from the Pachyderm contour repository and save our images in the correct output repository.</li>
			</ul>
			<p>Let's take a closer look at what the script does. The <strong class="source-inline">create_histogram</strong> function reads image files from the contour repository. Then, using the <strong class="source-inline">matploit.pyplot.hist</strong> (<strong class="source-inline">plt.hist</strong>) function, the script creates a histogram with the following parameters:</p>
			<ul>
				<li>The <strong class="source-inline">numpy.ravel</strong> function converts our images from the 2D array into a 1D array, which<a id="_idIndexMarker612"/> is needed to plot a histogram.</li>
				<li>The <strong class="source-inline">bins</strong> parameter defines the shape and distribution of vertical bars in your histogram. To distribute them evenly on the plot, we have a defined range by using the <strong class="source-inline">np.arange</strong> function.</li>
				<li>The <strong class="source-inline">color='blue'</strong> parameter defines the color of the histogram bins.</li>
				<li>The <strong class="source-inline">alpha=0.5</strong> parameter defines the level of transparency.</li>
				<li>The <strong class="source-inline">rwidth=0.7</strong> parameter defines the width of each bin.</li>
				<li>The <strong class="source-inline">plt.yscale('log')</strong> parameter defines the logarithmic y-axis scale. We need this parameter to narrow the scale of the y-axis for better data visualization.</li>
				<li>The <strong class="source-inline">plt.margins(x=0.03, y=-0.05)</strong> parameter determines the amount of whitespace between the histogram and the start of the plot.</li>
				<li>The <strong class="source-inline">plt.xlabel('Intensity')</strong> and <strong class="source-inline">plt.ylabel('Count')</strong> parameters define the labels for the x- and y-axes.</li>
				<li>The <strong class="source-inline">plt.savefig</strong> function defines where to save the histogram. In our case, we will save it in the <strong class="source-inline">pfs/out</strong> directory, in which Pachyderm will automatically create a histogram repository under the <strong class="source-inline">pfs/out/histogram</strong> path.<p class="callout-heading">Important note</p><p class="callout">In your scripts, you do not need to add the path to the repository, just to the <strong class="source-inline">pfs/out</strong> directory.</p></li>
			</ul>
			<h3>Pipeline specification overview</h3>
			<p>The <strong class="source-inline">histogram.yaml</strong> pipeline<a id="_idIndexMarker613"/> specification creates the histogram pipeline.</p>
			<p>Here is what our pipeline specification will look like:</p>
			<p class="source-code">---</p>
			<p class="source-code"> pipeline:</p>
			<p class="source-code">   name: histogram</p>
			<p class="source-code"> description: A pipeline that creates histograms for images stored in the contour repository.</p>
			<p class="source-code"> transform:</p>
			<p class="source-code">   cmd:</p>
			<p class="source-code">   - python3</p>
			<p class="source-code">   - "/histogram.py"</p>
			<p class="source-code">   image: svekars/contour-histogram:1.0</p>
			<p class="source-code"> input:</p>
			<p class="source-code">   pfs:</p>
			<p class="source-code">     repo: contour</p>
			<p class="source-code">     glob: "/"</p>
			<p>This pipeline does the following:</p>
			<ol>
				<li value="1">Uploads the files stored in the <strong class="source-inline">contour</strong> repository as a single datum</li>
				<li>Pulls the Docker image stored in Docker Hub under <strong class="source-inline">svekars/histogram:1.0</strong></li>
				<li>Runs the <strong class="source-inline">histogram.py</strong> script against all the files that have been downloaded from the <strong class="source-inline">contour</strong> repository</li>
				<li>Uploads the<a id="_idIndexMarker614"/> results of the transformation to the <strong class="source-inline">histogram</strong> output repository</li>
			</ol>
			<p>Now that we have reviewed what goes into this pipeline, let's go ahead and create it.</p>
			<h3>Creating the pipeline</h3>
			<p>The next step is to create<a id="_idIndexMarker615"/> the histogram pipeline, which will create a histogram for each image in the <strong class="source-inline">photos</strong> repository.</p>
			<p>Let's create the second step of our workflow by using the <strong class="source-inline">histogram.yaml</strong> file:</p>
			<ol>
				<li value="1">Log into your terminal.</li>
				<li>Verify that Pachyderm is up and running:<p class="source-code"><strong class="bold">% pachctl version</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">COMPONENT           VERSION</p>
			<p class="source-code">pachctl             2.0.0</p>
			<p class="source-code">pachd               2.0.0</p>
			<p>If <strong class="source-inline">pachd</strong> is unresponsive, you might need to run <strong class="source-inline">minikube stop</strong> and <strong class="source-inline">minikube start</strong> in a local installation to be able to resume working with it. If you are in a cloud environment, you will need to check your connection. If you are running Pachyderm in Pachyderm Hub, check that you are authenticated from the console and follow the onscreen instructions.</p>
			<ol>
				<li value="3">Create the <strong class="source-inline">histogram</strong> pipeline:<p class="source-code"><strong class="bold">% pachctl create pipeline -f histogram.yaml</strong></p></li>
			</ol>
			<p>No system output will be returned.</p>
			<ol>
				<li value="4">Verify that the pipeline was created:<p class="source-code"><strong class="bold">% pachctl list pipeline</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">NAME      VERSION INPUT     CREATED        STATE / LAST JOB  DESCRIPTION</p>
			<p class="source-code">contour   1       photos:/* 12 minutes ago running / success A pipeline that identifies contours on an image.</p>
			<p class="source-code">histogram 1       contour:/ 12 seconds ago running / success A pipeline that creates histograms for images stored in the contour repository.</p>
			<p>According to the preceding output, the histogram pipeline was created and is currently running the code.</p>
			<ol>
				<li value="5">Get the<a id="_idIndexMarker616"/> list of repositories:<p class="source-code"><strong class="bold">% pachctl list repo</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">NAME      CREATED            SIZE (MASTER) DESCRIPTION</p>
			<p class="source-code">histogram 23 seconds ago ≤ 27.48KiB    [repoOwner]  Output repo for pipeline histogram.</p>
			<p class="source-code">contour   24 minutes ago ≤ 117.6KiB    [repoOwner]  Output repo for pipeline contour.</p>
			<p class="source-code">photos    29 minutes ago ≤ 110.4KiB    [repoOwner]   </p>
			<p>The <strong class="source-inline">histogram</strong> output repository was created and contains 27.48 KiB of data. These are our histogram files.</p>
			<ol>
				<li value="6">List the files in the <strong class="source-inline">histogram</strong> repository:<p class="source-code"><strong class="bold">% pachctl list file histogram@master</strong></p></li>
			</ol>
			<p>The following is the system output:</p>
			<p class="source-code">NAME           TYPE     SIZE</p>
			<p class="source-code">/hand.png      file 9.361KiB</p>
			<p class="source-code">/landscape.png file 9.588KiB</p>
			<p class="source-code">/brown_vase.png  file 8.526KiB</p>
			<p>With that, our histogram visualizations have been added to the repository.</p>
			<ol>
				<li value="7">View the histogram files. For example, if you are on Mac, to view the <strong class="source-inline">landscape.png</strong> histogram file, run the following command:<p class="source-code"><strong class="bold">pachctl get file histogram@master:landscape.png | open -f -a Preview.app</strong></p></li>
			</ol>
			<p>Here is the<a id="_idIndexMarker617"/> resulting histogram:</p>
			<div>
				<div id="_idContainer058" class="IMG---Figure">
					<img src="Images/B17085_06_015.jpg" alt="" width="1153" height="879"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.15 – Histogram of the landscape image</p>
			<p>You can preview other files in a similar way or through the Pachyderm dashboard, as described earlier.</p>
			<ol>
				<li value="8">Go to the console and view the DAG for this newly added pipeline:</li>
			</ol>
			<div>
				<div id="_idContainer059" class="IMG---Figure">
					<img src="Images/B17085_06_016.jpg" alt="" width="699" height="92"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.16 – Updated DAG</p>
			<p>As you can<a id="_idIndexMarker618"/> see, you now have a new pipeline called <strong class="source-inline">histogram</strong> and a new eponymous output repository added to your DAG.</p>
			<p>Now that we have created our first pipeline, let's clean up our environment so that we have a clean cluster to work on the tasks in the next chapter.</p>
			<h2 id="_idParaDest-150"><a id="_idTextAnchor163"/>Cleaning up</h2>
			<p>Once you are <a id="_idIndexMarker619"/>done experimenting, you might want to clean up your cluster so that you start your next experiment with a fresh install. To clean up the environment, perform the following steps:</p>
			<ol>
				<li value="1">Delete all the pipelines and repositories:<p class="source-code"><strong class="bold">pachctl delete pipeline –all &amp;&amp; pachctl delete repo --all</strong></p></li>
				<li>Verify that no repositories and pipelines exist in your cluster:<p class="source-code"><strong class="bold">pachctl list repo &amp;&amp; pachctl list pipeline</strong></p></li>
			</ol>
			<p>You should see the following output:</p>
			<p class="source-code">NAME CREATED SIZE (MASTER) DESCRIPTION</p>
			<p class="source-code">NAME VERSION INPUT CREATED STATE / LAST JOB DESCRIPTION</p>
			<p>With that, you have successfully cleaned up your cluster.</p>
			<h1 id="_idParaDest-151"><a id="_idTextAnchor164"/>Summary</h1>
			<p>In this chapter, you successfully created your first Pachyderm repository, pipeline, and even extended it with another pipeline step. We used scikit-image, Matplotlib, and NumPy to create contours on images stored in Pachyderm repositories and created histograms for all of these images. This is the first step in understanding how Pachyderm works. In Pachyderm, you'll work with pipelines quite a lot. As you have already noticed, you can put any code in your pipeline. Although most of the examples in this book will use Python, you can use any programming language of your choice.</p>
			<p>In the next chapter, we will learn more about Pachyderm functionality, how to ingest data into Pachyderm and export it to outside systems, how to make changes to a pipeline's code, how to tune various parameters, and other important Pachyderm operations.</p>
			<h1 id="_idParaDest-152"><a id="_idTextAnchor165"/>Further reading</h1>
			<p>For more information about the topics that were covered in this chapter, take a look at the following resources:</p>
			<ul>
				<li>Docker Hub documentation: <a href="https://docs.docker.com/docker-hub/">https://docs.docker.com/docker-hub/</a></li>
				<li>Matplotlib documentation: <a href="https://matplotlib.org/">https://matplotlib.org/</a> </li>
				<li>NumPy documentation: <a href="https://numpy.org/doc/stable/">https://numpy.org/doc/stable/</a> </li>
				<li>Scikit-image documentation: <a href="https://scikit-image.org">https://scikit-image.org</a> </li>
				<li>Landscape image: <a href="https://www.freepik.com/free-vector/beautiful-gradient-spring-landscape_6969720.htm">https://www.freepik.com/free-vector/beautiful-gradient-spring-landscape_6969720.htm</a></li>
				<li>Brown vase image: <a href="https://www.freepik.com/free-photo/narrow-neck-vase_921733.htm">https://www.freepik.com/free-photo/narrow-neck-vase_921733.htm</a> </li>
				<li>Hand image: <a href="https://www.freepik.com/free-photo/hand-holding-something-with-white-background_978615.htm">https://www.freepik.com/free-photo/hand-holding-something-with-white-background_978615.htm</a> </li>
			</ul>
		</div>
	</div></body></html>