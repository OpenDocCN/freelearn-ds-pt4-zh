<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer123">
			<h1 id="_idParaDest-227"><em class="italic"><a id="_idTextAnchor241"/>Chapter 11</em>: Using Pachyderm Notebooks</h1>
			<p>In <a href="B17085_10_Final_SB_Epub.xhtml#_idTextAnchor220"><em class="italic">Chapter 10</em></a>, <em class="italic">Pachyderm Language Clients</em>, we learned how to use Pachyderm language clients, including the Pachyderm Go client and Pachyderm Python client. The latter is probably more popular among data scientists as Python is the language that a lot of data scientists use. And if you write in Python, you are likely familiar with the open source tool, <strong class="bold">JupyterLab</strong>.</p>
			<p>JupyterLab is an open source platform that provides an <strong class="bold">Interactive Development Environment</strong> (<strong class="bold">IDE</strong>) in which you can not only author your code but also execute it. This advantage makes JupyterLab an ideal tool for data science experiments. However, while JupyterLab provides a basic version control system for its notebooks, it's not to the level of data provenance that Pachyderm offers. Pachyderm Hub, the SaaS version of Pachyderm, provides a way to integrate your Pachyderm cluster with Pachyderm Notebooks, a built-in version of JupyterLab coupled with Pachyderm.</p>
			<p>This chapter is intended to demonstrate how to configure a Pachyderm cluster in Pachyderm Hub and use Pachyderm Notebooks. By the end of this chapter, we will learn how to run basic Pachyderm operations in Pachyderm Notebooks and will create a sentiment analysis pipeline.</p>
			<p>This chapter covers the following topics:</p>
			<ul>
				<li>Enabling Pachyderm Notebooks in Pachyderm Hub</li>
				<li>Running basic Pachyderm operations in Pachyderm Notebooks</li>
				<li>Creating and running an example pipeline in Pachyderm Notebooks</li>
			</ul>
			<h1 id="_idParaDest-228"><a id="_idTextAnchor242"/>Technical requirements</h1>
			<p>You should have already installed the following components: </p>
			<ul>
				<li><strong class="source-inline">pachctl</strong> 2.0.0 or later</li>
				<li>Access to Pachyderm Hub</li>
				<li>A GitHub or Gmail account</li>
			</ul>
			<h2 id="_idParaDest-229"><a id="_idTextAnchor243"/>Downloading the source files</h2>
			<p>All code samples used in this section are stored in the GitHub repository created for this book at <a href="https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/tree/main/Chapter11-Using-Pachyderm-Notebooks">https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/tree/main/Chapter11-Using-Pachyderm-Notebooks</a>.</p>
			<p>The <strong class="source-inline">Dockerfile</strong> used in this section is stored at <a href="https://hub.docker.com/repository/docker/svekars/pachyderm-ide">https://hub.docker.com/repository/docker/svekars/pachyderm-ide</a>.</p>
			<h1 id="_idParaDest-230"><a id="_idTextAnchor244"/>Enabling Pachyderm Notebooks in Pachyderm Hub</h1>
			<p>Before you can take advantage of Pachyderm Notebooks, you need to create an account in Pachyderm <a id="_idIndexMarker917"/>Hub and a Pachyderm <a id="_idIndexMarker918"/>workspace. Pachyderm Hub provides a trial period for all users to test its functionality. </p>
			<p>After the trial period ends, you need to upgrade to the Pachyderm Pro version to continue using Pachyderm Notebooks.</p>
			<h2 id="_idParaDest-231"><a id="_idTextAnchor245"/>Create a workspace</h2>
			<p>In Pachyderm Hub, your work is organized in <strong class="bold">workspaces</strong>. A workspace is a grouping in which <a id="_idIndexMarker919"/>multiple Pachyderm clusters can run. Your organization might decide to assign each workspace to a team of engineers.</p>
			<p>Before you can create a workspace, you need a Pachyderm Hub account, so let's create one. Pachyderm Hub supports authentication with Gmail and GitHub. You must have either of those to create an account with Pachyderm Hub.</p>
			<p>To create a Pachyderm Hub account, complete the following steps:</p>
			<ol>
				<li>Go to <a href="https://www.pachyderm.com/try-pachyderm-hub#">https://www.pachyderm.com/try-pachyderm-hub#</a> and fill out the provided form to request a free trial of Pachyderm Hub. It might take some time for your account to be activated and you will receive an email with instructions.</li>
				<li>Log in to your Pachyderm Hub account with the Gmail or GitHub account you have provided in the sign-up form. </li>
				<li>Fill out <a id="_idIndexMarker920"/>the <strong class="bold">Get Started</strong> form and click <strong class="bold">Get Started</strong>.</li>
				<li>Click <strong class="bold">Create a workspace</strong>, fill out the form that appears as shown in the following screenshot, and click <strong class="bold">Create</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer096" class="IMG---Figure">
					<img src="Images/B17085_11_001.jpg" alt="Figure 11.1 – Create a new workspace&#13;&#10;" width="456" height="540"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.1 – Create a new workspace</p>
			<p>When you create a workspace, you automatically deploy a Pachyderm cluster. If you're using a trial version of Pachyderm, you will have deployed a single-node cluster, which should be enough for testing.</p>
			<p>Now that you have created your first workspace, you need to connect to your cluster using <strong class="source-inline">pachctl</strong>.</p>
			<h2 id="_idParaDest-232"><a id="_idTextAnchor246"/>Connect to your Pachyderm Hub workspace with pachctl</h2>
			<p>If this is <a id="_idIndexMarker921"/>not the first chapter that you are reading in this book, you should already have <strong class="source-inline">pacthl</strong> installed on your computer. Otherwise, install <strong class="source-inline">pachctl</strong> as described in <a href="B17085_04_Final_SB_Epub.xhtml#_idTextAnchor096"><em class="italic">Chapter 4</em></a>, <em class="italic">Installing Pachyderm Locally</em>. </p>
			<p>To connect to your Pachyderm Hub workspace, do the following:</p>
			<ol>
				<li value="1">In the Pachyderm Hub UI, locate your workspace, and click the CLI link.</li>
				<li>Follow the instructions in the UI to switch your Pachyderm context and enable communication between your computer and your workspace on Pachyderm Hub. </li>
				<li>After you authenticate, run the following command:<p class="source-code">pachctl version</p></li>
			</ol>
			<p>You should get the following response:</p>
			<p class="source-code">COMPONENT           VERSION</p>
			<p class="source-code">pachctl             2.0.1</p>
			<p class="source-code">pachd               2.0.1</p>
			<ol>
				<li value="4">Check that you have switched to the correct context by running the following command:<p class="source-code">pachctl config get active-context</p></li>
			</ol>
			<p>This command should return the name of your Pachyderm Hub workspace.</p>
			<p>You can now communicate with your cluster deployed on Pachyderm Hub through <strong class="source-inline">pachctl</strong> from a terminal on your computer.</p>
			<p>Now that we have configured our cluster, let's connect to a Pachyderm notebook.</p>
			<h2 id="_idParaDest-233"><a id="_idTextAnchor247"/>Connect to a Pachyderm notebook</h2>
			<p><strong class="bold">Pachyderm Notebooks</strong> is an <strong class="bold">IDE</strong> for data scientists that provides easy access to familiar <a id="_idIndexMarker922"/>Python libraries. You can run and test your code in cells while Pachyderm backs your pipeline.  </p>
			<p>To connect to a Pachyderm notebook, complete the following steps:</p>
			<ol>
				<li value="1">In the Pachyderm Hub UI, in your workspace, click <strong class="bold">Notebooks</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer097" class="IMG---Figure">
					<img src="Images/B17085_11_002.jpg" alt="Figure 11.2 – Access Pachyderm Notebooks &#13;&#10;" width="616" height="138"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.2 – Access Pachyderm Notebooks </p>
			<ol>
				<li value="2">When prompted, click <strong class="bold">Sign in with OAuth 2.0</strong> and then sign in with the account that has access to Pachyderm Hub.</li>
				<li>On the <strong class="bold">Server Options</strong> screen, select the <strong class="bold">Default</strong> server:</li>
			</ol>
			<div>
				<div id="_idContainer098" class="IMG---Figure">
					<img src="Images/B17085_11_003.jpg" alt="Figure 11.3 – Server Options&#13;&#10;" width="704" height="445"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.3 – Server Options</p>
			<ol>
				<li value="4">Click <strong class="bold">Start</strong> and then <strong class="bold">Launch Server</strong>.</li>
			</ol>
			<p>You should see the following screen:</p>
			<div>
				<div id="_idContainer099" class="IMG---Figure">
					<img src="Images/B17085_11_004.jpg" alt="Figure 11.4 – Pachyderm Notebooks home&#13;&#10;" width="1115" height="684"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.4 – Pachyderm Notebooks home</p>
			<p>Now that <a id="_idIndexMarker923"/>we have access to Pachyderm Notebooks, we can create Pachyderm pipelines directly from the Pachyderm Notebooks UI, experiment with Python code and <strong class="source-inline">python-pachyderm</strong>, run <strong class="source-inline">pachctl</strong> commands, and even create <strong class="source-inline">Markdown</strong> files to document our experiments. We'll look into this functionality in the next section.</p>
			<h1 id="_idParaDest-234"><a id="_idTextAnchor248"/>Running basic Pachyderm operations in Pachyderm Notebooks</h1>
			<p>The main <a id="_idIndexMarker924"/>advantage of Pachyderm <a id="_idIndexMarker925"/>Notebooks is that it provides a unified experience. Not only can you run your experiments inside of it, but you can also access your Pachyderm cluster through the integrated terminal by using both <strong class="source-inline">pachctl</strong> and <strong class="source-inline">python-pachyderm</strong>. All the pipelines that you create through the JupyterLab UI will be reflected in your Pachyderm cluster whether it runs locally or on a <a id="_idIndexMarker926"/>cloud platform.</p>
			<p>Now let's <a id="_idIndexMarker927"/>see how we can use Pachyderm Notebooks to access our Pachyderm cluster.</p>
			<h2 id="_idParaDest-235"><a id="_idTextAnchor249"/>Using the integrated terminal</h2>
			<p>You can <a id="_idIndexMarker928"/>run the integrated terminal from within Pachyderm Notebooks and use it to execute <strong class="source-inline">pachctl</strong> or any other <strong class="source-inline">UNIX</strong> commands.</p>
			<p>To use the integrated terminal, complete the following steps:</p>
			<ol>
				<li value="1">On the Pachyderm Notebooks home page, click <strong class="bold">Terminal</strong>.</li>
				<li>Click the <strong class="bold">Terminal</strong> icon to start a new Terminal window:</li>
			</ol>
			<div>
				<div id="_idContainer100" class="IMG---Figure">
					<img src="Images/B17085_11_005.jpg" alt="Figure 11.5 – Start a Terminal within Pachyderm Notebooks&#13;&#10;" width="781" height="302"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.5 – Start a Terminal within Pachyderm Notebooks</p>
			<ol>
				<li value="3">Get the version of Pachyderm:<p class="source-code"><strong class="bold">pachctl version</strong></p></li>
			</ol>
			<p>Try running other Pachyderm commands that you have learned in previous chapters to see how it works.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The version of <strong class="source-inline">pachctl</strong> and <strong class="source-inline">pachd</strong> are different than the ones your run directly from your computer terminal as Pachyderm Notebooks has a preinstalled version of <strong class="source-inline">pachctl</strong>, which sometimes might not match the version of your cluster. This should not affect your work with Pachyderm.</p>
			<p>Now that <a id="_idIndexMarker929"/>we know how to use the terminal, let's try to create a Pachyderm notebook.</p>
			<h2 id="_idParaDest-236"><a id="_idTextAnchor250"/>Using Pachyderm Notebooks</h2>
			<p>A notebook is an interactive document in which the users can write Python code, run it, and <a id="_idIndexMarker930"/>visualize it. These features make notebooks a great experimentation tool that many data scientists use in their work. After the experiment is finished, you might want to export the notebook as a Python script or library.</p>
			<p>Pachyderm <a id="_idIndexMarker931"/>Notebooks supports the following types of notebooks:</p>
			<ul>
				<li>Python notebooks</li>
				<li>Julia notebooks</li>
				<li>R notebooks</li>
			</ul>
			<p>These three languages seem to be most popular among data scientists. You can create Julia and R notebooks to experiment specifically with the code that you want to use with your pipeline. With Python notebooks, not only you can test your code, but you can also use the <strong class="source-inline">python-pachyderm</strong> client to interact with the Pachyderm cluster.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The code described in this section can be found in the <a href="https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/blob/main/Chapter11-Using-Pachyderm-Notebooks/example.ipynb">https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/blob/main/Chapter11-Using-Pachyderm-Notebooks/example.ipynb</a> file.</p>
			<p>Let's create a Python notebook and run a few commands:</p>
			<ol>
				<li value="1">On the Pachyderm Notebooks home screen, click on the Python 3 notebook icon to create a new notebook. </li>
				<li>We can use both regular Python and <strong class="source-inline">python-pachyderm</strong> in this notebook. For example, to <a id="_idIndexMarker932"/>get the current version of your Pachyderm cluster and list all the repositories, paste the following in the notebook's cell:<p class="source-code">import python_pachyderm</p><p class="source-code">client = python_pachyderm.Client()</p><p class="source-code">print(client.get_remote_version())</p><p class="source-code">print(list(client.list_repo()))</p></li>
				<li>Click the run icon to run the script and get the result:</li>
			</ol>
			<div>
				<div id="_idContainer101" class="IMG---Figure">
					<img src="Images/B17085_11_006.jpg" alt="Figure 11.6 – Running python-pachyderm in Notebooks&#13;&#10;" width="720" height="556"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.6 – Running python-pachyderm in Notebooks</p>
			<ol>
				<li value="4">Create a repository by pasting the following code in the next cell and running it:<p class="source-code">client.create_repo("data")</p><p class="source-code">print(list(client.list_repo()))</p></li>
			</ol>
			<p>Here is <a id="_idIndexMarker933"/>the output that you should see:</p>
			<div>
				<div id="_idContainer102" class="IMG---Figure">
					<img src="Images/B17085_11_007.jpg" alt="Figure 11.7 – List repo&#13;&#10;" width="795" height="1053"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.7 – List repo</p>
			<p>Note that you do not need to import <strong class="source-inline">python_pachyderm</strong> and define the client in the second and subsequent cells since you have already defined it in the first cell.</p>
			<ol>
				<li value="5">Let's add some files to the data repository:<p class="source-code">with client.commit('data', 'master') as i:</p><p class="source-code">    client.put_file_url(i, 'total_vaccinations_dec_2020_24-31.csv', 'https://raw.githubusercontent.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/main/Chapter11-Using-Pachyderm-Notebooks/total_vaccinations_dec_2020_24-31.csv')</p><p class="source-code">print(list(client.list_file(("data", "master"), "")))</p></li>
			</ol>
			<p>Here is <a id="_idIndexMarker934"/>the output that you should see:</p>
			<div>
				<div id="_idContainer103" class="IMG---Figure">
					<img src="Images/B17085_11_008.jpg" alt="Figure 11.8 – Put file output&#13;&#10;" width="1210" height="505"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.8 – Put file output</p>
			<p>This dataset contains statistics about COVID-19 vaccinations from December 24 to 31, 2020. </p>
			<ol>
				<li value="6">You can print the contents of the file by running the following code:<p class="source-code">import pandas as pd</p><p class="source-code">pd.read_csv(client.get_file(("data", "master"), "total_vaccinations_dec_2020_24-31.csv"))</p></li>
			</ol>
			<p>You should see the following output:</p>
			<div>
				<div id="_idContainer104" class="IMG---Figure">
					<img src="Images/B17085_11_009.jpg" alt="Figure 11.9 – Total vaccinations&#13;&#10;" width="1139" height="739"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.9 – Total vaccinations</p>
			<p>This CSV file has the following columns: <strong class="bold">location</strong>, <strong class="bold">date</strong>, <strong class="bold">vaccine</strong> (manufacturer), and <strong class="bold">total_vaccinations</strong>.</p>
			<ol>
				<li value="7">Let's <a id="_idIndexMarker935"/>also print the top five rows of the file to view the names of the columns:<p class="source-code">import pandas as pd</p><p class="source-code">df = pd.read_csv(client.get_file(("data", "master"), "total_vaccinations_dec_2020_24-31.csv"))</p><p class="source-code">data_top = df.head() </p><p class="source-code">print(data_top)</p></li>
			</ol>
			<p>You should see the following output:</p>
			<div>
				<div id="_idContainer105" class="IMG---Figure">
					<img src="Images/B17085_11_010.jpg" alt="Figure 11.10 – Top five rows&#13;&#10;" width="882" height="352"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.10 – Top five rows</p>
			<ol>
				<li value="8">Finally, let's <a id="_idIndexMarker936"/>create a simple pipeline that will tell us which country did the most vaccinations in a single given day during the observed period:<p class="source-code"> from python_pachyderm.service import pps_proto</p><p class="source-code">client.create_pipeline(</p><p class="source-code">     pipeline_name="find-vaccinations",</p><p class="source-code">     transform=pps_proto.Transform(</p><p class="source-code">         cmd=["python3"],</p><p class="source-code">         stdin=[</p><p class="source-code">             "import pandas as pd",</p><p class="source-code">             "df = pd.read_csv('/pfs/data/total_vaccinations_dec_2020_24-31.csv')",</p><p class="source-code">             "max_vac = df['total_vaccinations'].idxmax()",</p><p class="source-code">             "row = df.iloc[[max_vac]]",</p><p class="source-code">             "row.to_csv('/pfs/out/max_vaccinations.csv', header=None, index=None, sep=' ', mode='a')",</p><p class="source-code">         ],</p><p class="source-code">         image="amancevice/pandas",</p><p class="source-code">     ),</p><p class="source-code">     input=pps_proto.Input(</p><p class="source-code">         pfs=pps_proto.PFSInput(glob="/", repo="data")</p><p class="source-code">     ),</p><p class="source-code">)</p><p class="source-code">print(list(client.list_pipeline()))</p></li>
			</ol>
			<p>You <a id="_idIndexMarker937"/>should see the following output:</p>
			<div>
				<div id="_idContainer106" class="IMG---Figure">
					<img src="Images/B17085_11_011.jpg" alt="Figure 11.11 – Create pipeline output&#13;&#10;" width="1153" height="789"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.11 – Create pipeline output</p>
			<ol>
				<li value="9">Let's get the result of our pipeline by executing the following code:<p class="source-code">client.get_file(("find-vaccinations", "master"), "/max_vaccinations.csv").read() </p></li>
			</ol>
			<p>You should see the following output:</p>
			<div>
				<div id="_idContainer107" class="IMG---Figure">
					<img src="Images/B17085_11_012.jpg" alt="Figure 11.12 – Results of the pipeline&#13;&#10;" width="1139" height="117"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.12 – Results of the pipeline</p>
			<p>Our <a id="_idIndexMarker938"/>pipeline has determined that during the period from December 24 to December 31, the most vaccinations were done in <strong class="bold">Germany</strong> on <strong class="bold">December 31</strong>. The number of vaccinations was <strong class="bold">206443</strong> and the manufacturer was <strong class="bold">Pfizer/BioNTech</strong>.</p>
			<ol>
				<li value="10">To clean up your cluster, run the following:<p class="source-code">client.delete_repo("data", force=True)</p><p class="source-code">client.delete_pipeline("find-vaccinations")</p><p class="source-code">print(list(client.list_repo()))</p><p class="source-code">print(list(client.list_pipeline()))</p></li>
			</ol>
			<p>You should see the following output:</p>
			<div>
				<div id="_idContainer108" class="IMG---Figure">
					<img src="Images/B17085_11_013.jpg" alt="Figure 11.13 – Cluster clean up&#13;&#10;" width="790" height="305"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.13 – Cluster clean up</p>
			<p>In this <a id="_idIndexMarker939"/>section, we learned how to perform basic Pachyderm operations in Pachyderm Python Notebooks. Next, we'll create another example pipeline. </p>
			<h1 id="_idParaDest-237"><a id="_idTextAnchor251"/>Creating and running an example pipeline in Pachyderm Notebooks</h1>
			<p>In the <a id="_idIndexMarker940"/>previous section, we learned <a id="_idIndexMarker941"/>how to use Pachyderm Notebooks, create repositories, put data, and even created a simple pipeline. In this section, we will create a pipeline that performs sentiment analysis on a Twitter dataset.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The code described in this section can be found in the <a href="https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/blob/main/Chapter11-Using-Pachyderm-Notebooks/sentiment-pipeline.ipynb">https://github.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/blob/main/Chapter11-Using-Pachyderm-Notebooks/sentiment-pipeline.ipynb</a> file.</p>
			<p>We will use a modified version of the International Women's Day Tweets dataset from Kaggle available at <a href="https://www.kaggle.com/michau96/international-womens-day-tweets">https://www.kaggle.com/michau96/international-womens-day-tweets</a>. Our modified version includes only two columns—tweet number <strong class="bold">#</strong> and <strong class="bold">text</strong>. The dataset includes <strong class="bold">51,480</strong> rows.</p>
			<p>Here is an extract of the first few rows of the dataset:</p>
			<p class="source-code">    #                        text</p>
			<p class="source-code">0  3  "She believed she could, so she did." #interna...</p>
			<p class="source-code">1  4  Knocking it out of the park again is\r\n@marya...</p>
			<p class="source-code">2  5  Happy International Women's Day! Today we are ...</p>
			<p class="source-code">3  6  Happy #InternationalWomensDay You're all power...</p>
			<p class="source-code">4  7  Listen to an experimental podcast recorded by ...</p>
			<p>Here is a diagram of the workflow:</p>
			<div>
				<div id="_idContainer109" class="IMG---Figure">
					<img src="Images/B17085_11_014.jpg" alt="Figure 11.14 – Sentiment analysis pipeline&#13;&#10;" width="1203" height="643"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.14 – Sentiment analysis pipeline</p>
			<p>In the <a id="_idIndexMarker942"/>next section, we will learn <a id="_idIndexMarker943"/>about the methodology that is used to build this pipeline. </p>
			<h2 id="_idParaDest-238"><a id="_idTextAnchor252"/>Pipeline methodology</h2>
			<p>We will use <strong class="bold">Natural Language Toolkit</strong> (<strong class="bold">NLTK</strong>), which is familiar to us from previous chapters, to <a id="_idIndexMarker944"/>clean the data. Then, we will use <strong class="source-inline">TextBlob</strong>, an <a id="_idIndexMarker945"/>open source Python library for text processing, to perform sentiment analysis on the tweets in the dataset. </p>
			<p><strong class="bold">Sentiment analysis</strong> is a <a id="_idIndexMarker946"/>technique that helps understand the overall mood of the individuals involved in a specific conversation, discussing specific products and services, or rating a movie. Sentiment analysis is widely used in various types of businesses and industries by marketers and sociologists to get a quick assessment of customer sentiment. In this example, we will be looking at emotions expressed in a selection of tweets about International Women's Day.</p>
			<p><strong class="source-inline">TextBlob</strong> provides <a id="_idIndexMarker947"/>two metrics for sentiment analysis—polarity and subjectivity. Each word in a sentence is assigned a score and then the mean score is assigned to the whole sentence. In this example, we will only determine the polarity of the tweets. Polarity defines the positivity or negativity of a sentence based on a predefined word intensity. </p>
			<p>Polarity <a id="_idIndexMarker948"/>values range from -1 to 1, with -1 meaning negative sentiment, 0 being neutral, and 1 being positive. If we were to show this on a scale, it would look like this:</p>
			<div>
				<div id="_idContainer110" class="IMG---Figure">
					<img src="Images/B17085_11_015.jpg" alt="Figure 11.15 – Polarity&#13;&#10;" width="1069" height="206"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.15 – Polarity</p>
			<p>If we were to put the words into a table and assign them polarity scores, here is what we might get:</p>
			<div>
				<div id="_idContainer111" class="IMG---Figure">
					<img src="Images/Table_012.jpg" alt="Figure 11.16 – Polarity scores&#13;&#10;" width="1135" height="242"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.16 – Polarity scores</p>
			<p>Let's run a quick <strong class="source-inline">TextBlob</strong> example on a simple sentence to see how it works. Use the code <a id="_idIndexMarker949"/>in the <strong class="source-inline">sentiment-test.py</strong> file to try this example:</p>
			<p class="source-code">from textblob import TextBlob</p>
			<p class="source-code">text = '''Here is the most simple example of a sentence. The rest of the text is autogenerated. This gives the program some time to perform its computations and then tries to find the shortest possible   possible sentence. Finally, let's look at the output that is used for the rest of the process.'''</p>
			<p class="source-code">blob = TextBlob(text)</p>
			<p class="source-code">blob.tags</p>
			<p class="source-code">blob.noun_phrases</p>
			<p class="source-code">for i in blob.sentences:</p>
			<p class="source-code">    print(i.sentiment.polarity)</p>
			<p>To run this script, complete the following steps:</p>
			<ol>
				<li value="1">You need to install <strong class="source-inline">TextBlob</strong> in the Pachyderm Notebooks terminal:<p class="source-code"><strong class="bold">pip install textblob &amp;&amp; python -m textblob.download_corpora</strong></p></li>
			</ol>
			<p>Here is the output that you should see:</p>
			<div>
				<div id="_idContainer112" class="IMG---Figure">
					<img src="Images/B17085_11_017.jpg" alt="Figure 11.17 – Installing TextBlob&#13;&#10;" width="1118" height="884"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.17 – Installing TextBlob</p>
			<ol>
				<li value="2">Run <strong class="source-inline">sentiment-test.py</strong> either <a id="_idIndexMarker950"/>in your local terminal or in a Jupyter notebook:</li>
			</ol>
			<div>
				<div id="_idContainer113" class="IMG---Figure">
					<img src="Images/B17085_11_018.jpg" alt="Figure 11.18 – Output of the sentiment-test.py script&#13;&#10;" width="1380" height="333"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.18 – Output of the sentiment-test.py script</p>
			<p>As you can see in the output, <strong class="source-inline">TextBlob</strong> assigns a score for each sentence.</p>
			<p>Now <a id="_idIndexMarker951"/>that we have reviewed the methodology of our example, let's create our pipelines.</p>
			<h2 id="_idParaDest-239"><a id="_idTextAnchor253"/>Creating the pipelines</h2>
			<p>Our first pipeline will use NLTK to clean the Twitter data in our <strong class="source-inline">data.csv</strong> file. We will create <a id="_idIndexMarker952"/>a standard Pachyderm pipeline by using <strong class="source-inline">python-pachyderm</strong>. The pipeline will consume files from the data repository, run the <strong class="source-inline">data-clean.py</strong> script on it, and output the cleaned text to the <strong class="source-inline">data-clean</strong> output repository. The pipeline will use the <strong class="source-inline">svekars/pachyderm-ide:1.0</strong> Docker image to run the code.</p>
			<p>The first part of <strong class="source-inline">data-clean.py</strong> imports the components that are familiar to us from <a href="B17085_08_Final_SB_Epub.xhtml#_idTextAnchor184"><em class="italic">Chapter 8</em></a>, <em class="italic">Creating an End-to-End Machine Learning Workflow</em>. These components include NLTK and <strong class="source-inline">pandas</strong>, which we will use to preprocess our data. We will also import <strong class="source-inline">re</strong> to specify regular expressions:</p>
			<p class="source-code">import nltk</p>
			<p class="source-code">import pandas as pd</p>
			<p class="source-code">from nltk.corpus import stopwords</p>
			<p class="source-code">from nltk.tokenize import word_tokenize</p>
			<p class="source-code">nltk.download('wordnet')</p>
			<p class="source-code">nltk.download('punkt')</p>
			<p class="source-code">import re</p>
			<p>The second part of the script performs the data cleaning using the NLTK <strong class="source-inline">word_tokenize</strong> method, <strong class="source-inline">stopwords</strong> with the <strong class="source-inline">lambda</strong> function, and <strong class="source-inline">re.split</strong> to remove the URLs. Finally, the script saves the cleaned text to <strong class="source-inline">cleaned-data.csv</strong> in the output repository:</p>
			<p class="source-code">stopwords = stopwords.words("english")</p>
			<p class="source-code">data = pd.read_csv("/pfs/data/data.csv", delimiter=",")</p>
			<p class="source-code">tokens = data['text'].apply(word_tokenize)</p>
			<p class="source-code">remove_stopwords = tokens.apply(lambda x: [w for w in x if w not in stopwords and w.isalpha()])</p>
			<p class="source-code">remove_urls = remove_stopwords.apply(lambda x: re.split('https:\/\/.*', str(x))[0])</p>
			<p class="source-code">remove_urls.to_csv('/pfs/out/cleaned-data.csv', index=True)</p>
			<p>Our second pipeline will perform sentiment analysis on the cleaned data with the <strong class="source-inline">TextBlob</strong> Python library. The <strong class="source-inline">sentiment.py</strong> script imports the following components:</p>
			<p class="source-code">from textblob import TextBlob</p>
			<p class="source-code">import pandas as pd</p>
			<p class="source-code">import seaborn as sns</p>
			<p class="source-code">import matplotlib.pyplot as plt</p>
			<p class="source-code">from contextlib import redirect_stdout</p>
			<p>We'll <a id="_idIndexMarker953"/>use <strong class="source-inline">pandas</strong> to manipulate the data frames. We'll use <strong class="source-inline">matplotlib</strong> and <strong class="source-inline">seaborn</strong> to visualize our results, and we'll use <strong class="source-inline">redirect_stdout</strong> to save our results to a file.</p>
			<p>Next, our script performs sentiment analysis and creates two new columns—<strong class="source-inline">polarity_score</strong> and <strong class="source-inline">sentiment</strong>. The resulting table is saved to a new CSV file called <strong class="source-inline">polarity.csv</strong>:</p>
			<p class="source-code">data = pd.read_csv('/pfs/data-clean/cleaned-data.csv', delimiter=',')</p>
			<p class="source-code">data = data[['text']]</p>
			<p class="source-code">data["polarity_score"] = data["text"].apply(lambda data: TextBlob(data).sentiment.polarity)</p>
			<p class="source-code">data['sentiment'] = data['polarity_score'].apply(lambda x: 'Positive' if x &gt;= 0.1 else ('Negative' if x &lt;= -0.1 else 'Neutral'))</p>
			<p class="source-code">print(data.head(10))</p>
			<p class="source-code">data.to_csv('/pfs/out/polarity.csv', index=True)</p>
			<p>Then, the script saves the tweets of sentiment category to its own variable, calculates the total for each category, and saves the totals to the <strong class="source-inline">number_of_tweets.txt</strong> file:</p>
			<p class="source-code">positive = [ data for index, t in enumerate(data['text']) if data['polarity_score'][index] &gt; 0]</p>
			<p class="source-code">neutral = [ data for index, tweet in enumerate(data['text']) if data['polarity_score'][index] == 0]</p>
			<p class="source-code">negative = [ data for index, t in enumerate(data['text']) if data['polarity_score'][index] &lt; 0]</p>
			<p class="source-code">with open('/pfs/out/number_of_tweets.txt', 'w') as file:</p>
			<p class="source-code">      with redirect_stdout(file):</p>
			<p class="source-code">          print("Number of Positive tweets:", len(positive))</p>
			<p class="source-code">          print("Number of Neutral tweets:", len(neutral))</p>
			<p class="source-code">          print("Number of Negative tweets:", len(negative))</p>
			<p>The last <a id="_idIndexMarker954"/>part of the script builds a pie chart with the percentages of tweets in each category and saves them to the <strong class="source-inline">plot.png</strong> file:</p>
			<p class="source-code">colors = ['#9b5de5','#f15bb5','#fee440']</p>
			<p class="source-code">figure = pd.DataFrame({'percentage': [len(positive), len(negative), len(neutral)]},</p>
			<p class="source-code">                       index=['Positive', 'Negative', 'Neutral'])</p>
			<p class="source-code">plot = figure.plot.pie(y='percentage', figsize=(5, 5), autopct='%1.1f%%', colors=colors)</p>
			<p class="source-code">circle = plt.Circle((0,0),0.70,fc='white')</p>
			<p class="source-code">fig = plt.gcf()</p>
			<p class="source-code">fig.gca().add_artist(circle)</p>
			<p class="source-code">plot.axis('equal')</p>
			<p class="source-code">plt.tight_layout()</p>
			<p class="source-code">plot.figure.savefig("/pfs/out/plot.png")</p>
			<p>Let's <a id="_idIndexMarker955"/>create these pipelines:</p>
			<ol>
				<li value="1">Create a new Pachyderm Python notebook.</li>
				<li>Create a Pachyderm <strong class="source-inline">data</strong> repository:<p class="source-code">import python_pachyderm</p><p class="source-code">client = python_pachyderm.Client()</p><p class="source-code">client.create_repo("data")</p><p class="source-code">print(list(client.list_repo()))</p></li>
			</ol>
			<p>You should see the following output:</p>
			<div>
				<div id="_idContainer114" class="IMG---Figure">
					<img src="Images/B17085_11_019.jpg" alt="Figure 11.19 – Output of the created repository&#13;&#10;" width="606" height="546"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.19 – Output of the created repository</p>
			<ol>
				<li value="3">Put the <strong class="source-inline">data.csv</strong> file in this repository:<p class="source-code">with client.commit('data', 'master') as i:</p><p class="source-code">     client.put_file_url(i, 'data.csv', 'https://raw.githubusercontent.com/PacktPublishing/Reproducible-Data-Science-with-Pachyderm/main/Chapter11-Using-Pachyderm-Notebooks/data.csv')</p><p class="source-code">print(list(client.list_file(("data", "master"), ""))) </p></li>
			</ol>
			<p>This <a id="_idIndexMarker956"/>script returns the following output: </p>
			<div>
				<div id="_idContainer115" class="IMG---Figure">
					<img src="Images/B17085_11_020.jpg" alt="Figure 11.20 – Put file output&#13;&#10;" width="1211" height="508"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.20 – Put file output</p>
			<ol>
				<li value="4">List the files in the data repository:<p class="source-code">list(client.list_file(("data", "master"), ""))</p></li>
			</ol>
			<p>You should see the following response:</p>
			<div>
				<div id="_idContainer116" class="IMG---Figure">
					<img src="Images/B17085_11_021.jpg" alt="Figure 11.21 – List file output&#13;&#10;" width="1212" height="565"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.21 – List file output</p>
			<ol>
				<li value="5">Create <a id="_idIndexMarker957"/>the <strong class="source-inline">data-clean</strong> pipeline: <p class="source-code">from python_pachyderm.service import pps_proto</p><p class="source-code">client.create_pipeline(</p><p class="source-code">     pipeline_name="data-clean",</p><p class="source-code">     transform=pps_proto.Transform(</p><p class="source-code">         cmd=["python3", "data-clean.py"],</p><p class="source-code">         image="svekars/pachyderm-ide:1.0",</p><p class="source-code">     ),</p><p class="source-code">     input=pps_proto.Input(</p><p class="source-code">         pfs=pps_proto.PFSInput(glob="/", repo="data")</p><p class="source-code">     ),</p><p class="source-code">)</p><p class="source-code">client.create_pipeline(</p><p class="source-code">     pipeline_name="sentiment",</p><p class="source-code">     transform=pps_proto.Transform(</p><p class="source-code">         cmd=["python3", "sentiment.py"],</p><p class="source-code">         image="svekars/pachyderm-ide:1.0",</p><p class="source-code">     ),</p><p class="source-code">     input=pps_proto.Input(</p><p class="source-code">         pfs=pps_proto.PFSInput(glob="/", repo="data-clean")</p><p class="source-code">     ),</p><p class="source-code">)</p><p class="source-code">print(list(client.list_pipeline()))</p></li>
			</ol>
			<p>You <a id="_idIndexMarker958"/>should see the following output:</p>
			<div>
				<div id="_idContainer117" class="IMG---Figure">
					<img src="Images/B17085_11_022.jpg" alt="Figure 11.22 – Create pipeline output&#13;&#10;" width="665" height="998"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.22 – Create pipeline output</p>
			<p>The <a id="_idIndexMarker959"/>output is truncated and shows only the <strong class="source-inline">data-clean</strong> pipeline. You should see similar output for the <strong class="source-inline">sentiment</strong> pipeline.</p>
			<ol>
				<li value="6">Let's view the first few lines of the file in the <strong class="source-inline">data-clean</strong> repository that has our cleaned data:<p class="source-code">import pandas as pd</p><p class="source-code">pd.read_csv(client.get_file(("data-clean", "master"), "cleaned-data.csv"), nrows=10)</p></li>
			</ol>
			<p>This script returns the following output:</p>
			<div>
				<div id="_idContainer118" class="IMG---Figure">
					<img src="Images/B17085_11_023.jpg" alt="Figure 11.23 – Cleaned data&#13;&#10;" width="1194" height="628"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.23 – Cleaned data</p>
			<p>You can <a id="_idIndexMarker960"/>see that the text was broken down into tokens.</p>
			<ol>
				<li value="7">Let's get the list of files in the sentiment repository:<p class="source-code">list(client.list_file(("sentiment","master"), ""))</p></li>
			</ol>
			<p>You should see a lengthy output. The files will be under <strong class="source-inline">path:</strong>, similar to the following response:</p>
			<div>
				<div id="_idContainer119" class="IMG---Figure">
					<img src="Images/B17085_11_024.jpg" alt="Figure 11.24 – List of files in the sentiment repository&#13;&#10;" width="1168" height="611"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.24 – List of files in the sentiment repository</p>
			<p>There <a id="_idIndexMarker961"/>should be three files, as follows: </p>
			<ul>
				<li><strong class="source-inline">number_of_tweets.txt</strong>: A text file with the total number of tweets in each category</li>
				<li><strong class="source-inline">plot.png</strong>: A pie chart with the percentages of tweets in each category</li>
				<li><strong class="source-inline">polarity.csv</strong>: A new CSV table with the <strong class="source-inline">polarity_score</strong> and <strong class="source-inline">sentiment</strong> columns</li>
			</ul>
			<ol>
				<li value="8">Now, let's look at the first few rows of the <strong class="source-inline">polarity.csv</strong> table:<p class="source-code">pd.read_csv(client.get_file(("sentiment","master"), "polarity.csv"), nrows=10)</p></li>
			</ol>
			<p>This script returns the following output:</p>
			<div>
				<div id="_idContainer120" class="IMG---Figure">
					<img src="Images/B17085_11_025.jpg" alt="Figure 11.25 – Polarity and sentiment results &#13;&#10;" width="1187" height="606"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.25 – Polarity and sentiment results </p>
			<p>You can see the two new columns appended to our original table, giving a polarity score in the range [-1;1] and a sentiment category.</p>
			<ol>
				<li value="9">Let's see <a id="_idIndexMarker962"/>the total number for each sentiment category:<p class="source-code">client.get_file(("sentiment", "master"),"number_of_tweets.txt").read() </p></li>
			</ol>
			<p>You should see the following output: </p>
			<div>
				<div id="_idContainer121" class="IMG---Figure">
					<img src="Images/B17085_11_026.jpg" alt="Figure 11.26 – Total number of tweets for each category&#13;&#10;" width="1193" height="108"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.26 – Total number of tweets for each category</p>
			<ol>
				<li value="10">Finally, let's look at the pie chart with sentiment category percentages:<p class="source-code">from IPython.display import display</p><p class="source-code">from PIL import Image</p><p class="source-code">display(Image.open(client.get_file(("sentiment", "master"), "/plot.png")))</p></li>
			</ol>
			<p>This <a id="_idIndexMarker963"/>script returns the following output:</p>
			<div>
				<div id="_idContainer122" class="IMG---Figure">
					<img src="Images/B17085_11_027.jpg" alt="Figure 11.27 – Percentage of positive, negative, and neutral sentiments&#13;&#10;" width="1211" height="950"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.27 – Percentage of positive, negative, and neutral sentiments</p>
			<p>Based on this chart, we can tell that the majority of the tweets contain positive sentiments and the percentage of negative tweets can be considered insignificant.</p>
			<p>This concludes our sentiment analysis example.</p>
			<h1 id="_idParaDest-240"><a id="_idTextAnchor254"/>Summary</h1>
			<p>In this chapter, we have learned how to create Pachyderm notebooks in Pachyderm Hub, a powerful addition to Pachyderm that enables data scientists to leverage the benefits of an integrated environment with the Pachyderm data lineage functionality and pipelines. Data scientists spend hours performing exploratory data analysis and do so in notebooks. Combining Pachyderm and notebooks brings data scientists and data engineers together on one platform, letting them speak the same language and use the same tools.</p>
			<p>In addition to the above, we created a pipeline that performs basic sentiment analysis of Twitter data and ran it completely in a Pachyderm notebook. We have expanded our knowledge of Python Pachyderm and how it can be used in conjunction with other tools and libraries.</p>
			<h1 id="_idParaDest-241"><a id="_idTextAnchor255"/>Further reading</h1>
			<ul>
				<li>JupyterLab documentation: https://jupyterlab.readthedocs.io/en/stable/ </li>
				<li><strong class="source-inline">TextBlob</strong> documentation: <a href="https://textblob.readthedocs.io/en/dev/">https://textblob.readthedocs.io/en/dev/</a> </li>
				<li><strong class="source-inline">python-pachyderm</strong> documentation: <a href="https://python-pachyderm.readthedocs.io/en/stable/">https://python-pachyderm.readthedocs.io/en/stable/</a></li>
			</ul>
		</div>
	</div></body></html>